<?php	error_reporting(E_ERROR);	session_start();	if (!function_exists("get_header"))		require_once("../../includes/functions.gerais.php");	if (!function_exists("mpress_query"))		require_once("../../config.php");	function alteraTarefaDataRetorno($idTarefa){		$userID		= $_SESSION['dadosUserLogin']['userID'];		$dataAlterada 	= converteDataHora($_POST['data-retorno']);		$dataHoraAtual = "'".retornaDataHora('','Y-m-d H:i:s')."'";		$alterarDatasSequencia = $_POST['alterar-datas-sequencia'];		$grupoResponsavelID = $_POST['grupo-responsavel'];		$usuarioResponsavelID = $_POST['usuario-responsavel'];		$descricaoInicial = $_POST['descricao-inicial'];		$motivo = utf8_decode($_POST['descricao-tarefa-follow']);		$sql = "Select DATE_FORMAT(pvt.Data_Limite,'%d/%m/%Y %H:%i') as Data_Limite, pvt.Projeto_Vinculo_ID, pvt.Posicao, pvt.Grupo_Responsavel_ID, pvt.Usuario_Responsavel_ID, cd.Nome as Usuario, ma.Titulo as Grupo				from projetos_vinculos_tarefas pvt				left join cadastros_dados cd on cd.Cadastro_ID = pvt.Usuario_Responsavel_ID				left join modulos_acessos ma on ma.Modulo_Acesso_ID = pvt.Grupo_Responsavel_ID				where pvt.Projeto_Vinculo_Tarefa_ID = '".$_POST['tarefa-id']."'";		//echo $sql;		$resultSet = mpress_query($sql);		if ($rs = mpress_fetch_array($resultSet)){			$dataRetorno = $rs['Data_Limite'];			$projetoVinculoID = $rs['Projeto_Vinculo_ID'];			$posicao = $rs['Posicao'];			$grupoResponsavelIDAnt = $rs['Grupo_Responsavel_ID'];			$usuarioResponsavelIDAnt = $rs['Usuario_Responsavel_ID'];			$grupoAnt = $rs['Grupo'];			$usuarioAnt = $rs['Usuario'];		}		$flag = 0;		if ($dataRetorno != $_POST['data-retorno']){			$flag=1;			$descricaoFollow = "Data de retorno alterada de <b>$dataRetorno</b> para <b>".$_POST['data-retorno']."</b><br>";			if ($alterarDatasSequencia=="S"){				/* FUNÇÃO DE ATUALIZAÇÃO DE DATAS POSTERIORES */				$descricaoFollow .= "*** <font color=red>Atualizado datas das tarefas sequenciais</font><br>";				if (($projetoVinculoID!="") && ($posicao!="")){					$sql = "select Data_Limite, Projeto_Vinculo_Tarefa_ID, Tempo_Execucao								from projetos_vinculos_tarefas pvt								inner join projetos_vinculos pv on pv.Projeto_Vinculo_ID = pvt.Projeto_Vinculo_ID								where pv.Projeto_Vinculo_ID = '$projetoVinculoID' AND pvt.Posicao > $posicao								order by pvt.Posicao";					$i = 0;					$resultSet = mpress_query($sql);					while($rs = mpress_fetch_array($resultSet)){						$tempoExecucao += $rs['Tempo_Execucao'];						$dataLimiteFilho = converteDataHora($rs['Data_Limite'],1);						$sql = "update projetos_vinculos_tarefas set Data_Limite = DATE_ADD('$dataAlterada', INTERVAL $tempoExecucao DAY)									where Projeto_Vinculo_Tarefa_ID = '".$rs['Projeto_Vinculo_Tarefa_ID']."'";						mpress_query($sql);						$sql = "insert into projetos_vinculos_tarefas_follows (Projeto_Vinculo_Tarefa_ID, Descricao, Hora_Inicio, Hora_Fim, Data_Cadastro, Usuario_Cadastro_ID)								values ('".$rs['Projeto_Vinculo_Tarefa_ID']."', concat('Data de Retorno alterada de <b>$dataLimiteFilho</b> para <b>', DATE_FORMAT(DATE_ADD('$dataAlterada', INTERVAL $tempoExecucao DAY),'%d/%m/%Y %H:%i'), '</b><br>Motivo: <font color=red>*** $motivo </font>'), $dataHoraAtual, $dataHoraAtual, $dataHoraAtual, $userID)";						mpress_query($sql);					}				}			}		}		if ($grupoResponsavelID!=$grupoResponsavelIDAnt){			$flag = 1;			$resultSet = mpress_query("select Titulo from modulos_acessos where Modulo_Acesso_ID = '$grupoResponsavelID'");			if($rs = mpress_fetch_array($resultSet))				$grupo = $rs['Titulo'];			$descricaoFollow .= "Grupo respons&aacute;vel alterado de <b>$grupoAnt</b> para <b>$grupo</b><br>";		}		if ($usuarioResponsavelID!=$usuarioResponsavelIDAnt){			$flag = 1;			$resultSet = mpress_query("select Nome from cadastros_dados where Cadastro_ID = '$usuarioResponsavelID'");			if($rs = mpress_fetch_array($resultSet))				$usuario = $rs['Nome'];			$descricaoFollow .= "Usu&aacute;rio respons&aacute;vel alterado de <b>$usuarioAnt</b> para <b>$usuario</b><br>";		}		if ($flag==1){			$sql = "update projetos_vinculos_tarefas set Data_Limite = '$dataAlterada',												Grupo_Responsavel_ID = '$grupoResponsavelID',												Usuario_Responsavel_ID = '$usuarioResponsavelID',												Descricao_Inicial = '$descricaoInicial'									where Projeto_Vinculo_Tarefa_ID = '".$_POST['tarefa-id']."'";			mpress_query($sql);		}		$descricaoFollow .= "Motivo: <font color=red>*** $motivo </font>";		$sql = "insert into projetos_vinculos_tarefas_follows (Projeto_Vinculo_Tarefa_ID, Descricao, Hora_Inicio, Hora_Fim, Data_Cadastro, Usuario_Cadastro_ID)				values ('".$_POST['tarefa-id']."', '$descricaoFollow', $dataHoraAtual, $dataHoraAtual, $dataHoraAtual, $userID)";		mpress_query($sql);	}	function carregarTarefaDetalhes($tarefaID){		$resultSet = mpress_query("select Descricao from tarefas where Tarefa_ID = '$tarefaID'");		if($rs = mpress_fetch_array($resultSet))			$descricao = $rs['Descricao'];		return $descricao;	}	function cadastrarTarefaGeral(){		global $dadosUserLogin;		$dataHoraAtual = "'".retornaDataHora('','Y-m-d H:i:s')."'";		$projetoVinculoID = $_POST['projeto-vinculo-id'];		$tarefaID = $_POST['tarefa-seleciona-tarefa-id'];		$aleatorio = $_POST['tarefa-aleatorio'];
		//echo 'texto-descricao-tarefa-'.$aleatorio;
		$descricaoInicial = $_POST['texto-descricao-tarefa-'.$aleatorio];		$usuarioResponsavelID = $_POST['tarefa-usuario-responsavel'];		$grupoResponsavelID = $_POST['tarefa-grupo-responsavel'];		$posicao = $_POST['tarefa-posicao'];		$tempoExecucao = $_POST['tarefa-tempo-execucao'];		$dataLimite = converteDataHora($_POST['tarefa-data-limite']);		$enviarEmail = $_POST['enviar-email'];		$chaveEstrangeira = $_POST['chave-estrangeira-tarefa'];		$tabelaEstrangeira = $_POST['tabela-estrangeira-tarefa'];		$campoEstrangeiro = $_POST['campo-estrangeiro-tarefa'];		$cadastroAlvoID = $_POST['cadastro-alvo-id-tarefa'];				/*********** CASO TAREFA FOR PRA AGENDA PESSOAL ********/		/*		if ($tabelaEstrangeira=="cadastros_dados"){			$sql = "select Projeto_Vinculo_ID from projetos_vinculos												where Tabela_Estrangeira = '$tabelaEstrangeira' and Campo_Estrangeiro = 'Cadastro_ID'												and Chave_Estrangeira = '$usuarioResponsavelID' and Situacao_ID = 1";			echo "<br><br>".$sql;			$resultSet = mpress_query($sql);			if($rs = mpress_fetch_array($resultSet))				$projetoVinculoID = $rs['Projeto_Vinculo_ID'];			else{				$sql = "insert into projetos_vinculos								(Projeto_ID, Chave_Estrangeira, Tabela_Estrangeira, Campo_Estrangeiro, Usuario_Cadastro_ID, Data_Cadastro, Situacao_ID)						values 	('-1', '$usuarioResponsavelID', '$tabelaEstrangeira', 'Cadastro_ID', '".$dadosUserLogin['userID']."', $dataHoraAtual, 1)";				echo "<br><br>".$sql;				mpress_query($sql);				$projetoVinculoID = mpress_identity();			}		}		*/		/******************************************************/				$sql = "INSERT INTO projetos_vinculos_tarefas						(Projeto_Vinculo_ID, Tarefa_ID, Descricao_Inicial, Posicao, Tempo_Execucao, Data_Limite,						Chave_Estrangeira, Tabela_Estrangeira, Campo_Estrangeiro, Cadastro_Alvo_ID,						Grupo_Responsavel_ID, Usuario_Responsavel_ID, Usuario_Cadastro_ID, Situacao_ID, Data_Cadastro)				VALUES ('$projetoVinculoID', '$tarefaID', '$descricaoInicial', '$posicao', '$tempoExecucao', '$dataLimite',										'$chaveEstrangeira', '$tabelaEstrangeira', '$campoEstrangeiro', '$cadastroAlvoID',						'$grupoResponsavelID', '$usuarioResponsavelID', '".$dadosUserLogin['userID']."', 83, $dataHoraAtual)";		echo "<textarea>$sql</textarea>";						mpress_query($sql);		if ($enviarEmail!=""){			$titulo = "Tarefa";			$conteudo = gerarConteudoEmailTarefa($tarefaID);			echo enviaEmails($dadosEmail, $titulo, $conteudo, "<p>Envio efetuado com successo</p>");		}	}	function gerarConteudoEmailTarefa(){	}	/*	function cadastrarProjetoGeral(){		global $dadosUserLogin;		$dataHoraAtual = "'".retornaDataHora('','Y-m-d H:i:s')."'";		$projetoID = $_POST['projeto-incluir-geral'];		$chaveEstrangeira = $_POST['chave-estrangeira-tarefa'];		$tabelaEstrangeira = $_POST['tabela-estrangeira-tarefa'];		$campoEstrangeiro = $_POST['campo-estrangeiro-tarefa'];		$sql = "INSERT INTO projetos_vinculos						(Projeto_ID, Chave_Estrangeira, Tabela_Estrangeira, Campo_Estrangeiro, Usuario_Cadastro_ID, Data_Cadastro, Situacao_ID)				VALUES 	('$projetoID', '$chaveEstrangeira', '$tabelaEstrangeira', '$campoEstrangeiro', '".$dadosUserLogin['userID']."', $dataHoraAtual, 1)";		mpress_query($sql);	}	*/	function salvarTarefa(){		global $caminhoSistema;		if ($_POST['tipo-acao']=="I"){			mpress_query("insert into tarefas (Titulo, Descricao, Dados, Tempo_Execucao, Situacao_ID, Data_Cadastro, Usuario_Cadastro_ID)							values('".trim($_POST['titulo'])."','".$_POST['descricao']."','".serialize($_POST['dados'])."','".$_POST['tempo-execucao']."', 1, '".retornaDataHora('','Y-m-d H:i:s')."', '".$dadosUserLogin['userID']."')");			$retorno = "Registro Inserido com sucesso!";			$_POST['tarefa-id'] = mpress_identity();			//$tarefaID = "";		}		if ($_POST['tipo-acao']=="U"){			mpress_query("update tarefas set Titulo = '".trim($_POST['titulo'])."',											Descricao = '".$_POST['descricao']."',											Tempo_Execucao = '".$_POST['tempo-execucao']."',											Dados = '".serialize($_POST['dados'])."'											where Tarefa_ID = ".$_POST['tarefa-id']);			$retorno = "Registro Atualizado com sucesso!";			//$tarefaID = "";		}		if($_POST['tipo-acao']=="D"){			mpress_query("update tarefas set Situacao_ID = 3 where Tarefa_ID ='".$_POST['tarefa-id']."'");			$retorno = "Registro enviado para lixeira!";			$tarefaID = "";		}		if ($_POST['tarefa-id']!=""){			mpress_query("update tarefas_grupos set Situacao_ID = 3 where Tarefa_ID ='".$_POST['tarefa-id']."'");			foreach($_POST['grupo-id'] as $chave => $grupo){				mpress_query("insert into tarefas_grupos (Tarefa_ID, Grupo_ID, Situacao_ID) values ('".$_POST['tarefa-id']."', '$grupo', 1)");			}		}		echo "	<form action='".$caminhoSistema."/projetos/projetos-tarefas' method='post' name='retorno'></form>				<script>document.retorno.submit();</script>";	}?>