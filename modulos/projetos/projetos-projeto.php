<?php	include("functions.php");	global $modulosAtivos, $caminhoSistema;	$projetoID = $_POST['projeto-id'];	$projetoTarefaID = $_POST['projeto-tarefa-id'];	$posicaoTarefa = 1;	$escondeTarefa = "esconde";	$textoBotaoTarefa = "Incluir";	if($_SERVER['REQUEST_METHOD']=='POST'){		$request = md5(implode($_POST));		// define se é POST e não apenas um REFRESH		if(!(isset($_SESSION['last_request']) && $_SESSION['last_request'] == $request)){			$_SESSION['last_request']  = $request;			if ($_POST['acao']=="PI"){				if (($_POST['projeto-padrao']=="1") && ($_POST['tabela-estrangeira']!="")){					mpress_query("update projetos set Projeto_Padrao = 0 where Tabela_Estrangeira = '".$_POST['tabela-estrangeira']."'");				}				$sql = "insert into projetos (Titulo, Descricao, Tabela_Estrangeira, Projeto_Padrao, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)						values ('".$_POST['titulo']."', '".$_POST['descricao']."', '".$_POST['tabela-estrangeira']."', '".$_POST['projeto-padrao']."','".retornaDataHora('','Y-m-d H:i:s')."', '".$dadosUserLogin['userID']."', 1)";				mpress_query($sql);				$projetoID = mysql_insert_id();			}			if ($_POST['acao']=="PU"){				if (($_POST['projeto-padrao']=="1") && ($_POST['tabela-estrangeira']!="")){					mpress_query("update projetos set Projeto_Padrao = 0 where Tabela_Estrangeira = '".$_POST['tabela-estrangeira']."'");				}				$sql = "update projetos set Titulo = '".$_POST['titulo']."',											Descricao = '".$_POST['descricao']."',											Tabela_Estrangeira = '".$_POST['tabela-estrangeira']."',											Projeto_Padrao = '".$_POST['projeto-padrao']."'											where Projeto_ID = $projetoID";				mpress_query($sql);			}			if ($_POST['acao']=="PD") mpress_query("update projetos set Situacao_ID = 3 where Projeto_ID = '$projetoID'");			if ($_POST['acao']=="PDD"){				mpress_query("update projetos set Situacao_ID = 2 where Projeto_ID = '$projetoID'");			}			if ($_POST['acao']=="PR") mpress_query("update projetos set Situacao_ID = 1 where Projeto_ID = '$projetoID'");			if ($_POST['acao']=="TI"){				$sql = "insert into projetos_tarefas (Projeto_ID, Tarefa_ID, Posicao, Tempo_Execucao, Grupo_Responsavel_ID, Usuario_Responsavel_ID, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)									values ('$projetoID', '".$_POST['seleciona-tarefa-id']."', '".$_POST['posicao-tarefa']."', '".$_POST['tempo-execucao']."', '".$_POST['grupo-responsavel']."', '".$_POST['usuario-responsavel']."','".retornaDataHora('','Y-m-d H:i:s')."', '".$dadosUserLogin['userID']."', 1)";				mpress_query($sql);			}			if ($_POST['acao']=="TU"){				$sql = "update projetos_tarefas set Tarefa_ID = '".$_POST['seleciona-tarefa-id']."',													Posicao = '".$_POST['posicao-tarefa']."',													Tempo_Execucao = '".$_POST['tempo-execucao']."',													Grupo_Responsavel_ID = '".$_POST['grupo-responsavel']."',													Usuario_Responsavel_ID = '".$_POST['usuario-responsavel']."'													where Projeto_Tarefa_ID = '$projetoTarefaID'";				mpress_query($sql);				$projetoTarefaID = "";			}			if ($_POST['acao']=="TD"){				$sql = "update projetos_tarefas set Situacao_ID = 3 where Projeto_Tarefa_ID = '$projetoTarefaID'";				mpress_query($sql);				$projetoTarefaID = "";			}		}	}	$tempoExecucao = "";	if ($projetoID!=""){		$sql = "select Projeto_ID, Titulo, Descricao, Data_Cadastro, Tabela_Estrangeira, Projeto_Padrao, Usuario_Cadastro_ID, Situacao_ID from projetos where Projeto_ID = $projetoID";		$resultado1 = mpress_query($sql);		if ($rs1 = mpress_fetch_array($resultado1)){			$titulo = $rs1[Titulo];			$descricao = $rs1[Descricao];			$situacaoProjeto = $rs1[Situacao_ID];			if ($rs1[Projeto_Padrao]=="1") $projetoPadrao = " checked ";			$funcionalidade = $rs1[Tabela_Estrangeira];			$sql = "select pt.Projeto_Tarefa_ID, t.Tarefa_ID, pt.Posicao, pt.Tempo_Execucao, t.Titulo, pt.Grupo_Responsavel_ID, m.Titulo as Descricao_Grupo,							pt.Usuario_Responsavel_ID, r.Nome as Usuario_Responsavel							from projetos_tarefas pt							inner join tarefas t on pt.Tarefa_ID = t.Tarefa_ID							left join modulos_acessos m on m.Modulo_Acesso_ID = pt.Grupo_Responsavel_ID							left join cadastros_dados r on r.Cadastro_ID = pt.Usuario_Responsavel_ID							where pt.Situacao_ID = 1							and Projeto_ID = '$projetoID'							order by Posicao";			$resultado = mpress_query($sql);			while ($rs = mpress_fetch_array($resultado)){				$i++;				if (($projetoTarefaID==$rs[Projeto_Tarefa_ID]) && ($_POST['acao']!="TU")){					$tarefaID = $rs[Tarefa_ID];					$posicaoTarefa = $rs[Posicao];					$tempoExecucao = $rs[Tempo_Execucao];					$grupoResponsavelID = $rs[Grupo_Responsavel_ID];					$usuarioResponsavelID = $rs[Usuario_Responsavel_ID];					$escondeTarefa = "";				}				$dados[colunas][conteudo][$i][1] = "<p Style='margin:2px 5px 0 5px; float:left;'>".$rs[Titulo]."</p>";				$dados[colunas][conteudo][$i][2] = "<p Style='margin:2px 5px 0 5px; float:left;'>".$rs[Descricao_Grupo]."</p>";				$dados[colunas][conteudo][$i][3] = "<p Style='margin:2px 5px 0 5px; float:left;'>".$rs[Usuario_Responsavel]."</p>";				$dados[colunas][conteudo][$i][4] = "<p Style='margin:2px 5px 0 5px;' align='center'>".$rs[Tempo_Execucao]."</p>";				$dados[colunas][conteudo][$i][5] = "<p Style='margin:2px 5px 0 5px;' align='center'><input type='text' name='posicao-atual-".$rs[Projeto_Tarefa_ID]."' id='posicao-atual-".$rs[Projeto_Tarefa_ID]."' value='".$rs[Posicao]."' class='posicao-atual formata-numero' style='width:40px; text-align:center;' projeto-tarefa-id='".$rs[Projeto_Tarefa_ID]."'/></p>";				$dados[colunas][conteudo][$i][6] = "<p Style='margin:2px 5px 0 5px; float:left;'>												<div class='btn-excluir btn-excluir-tarefa-projeto' style='float:right; padding-right:5px' projeto-tarefa-id='".$rs[Projeto_Tarefa_ID]."' title='Excluir'>&nbsp;</div>												<div class='btn-editar btn-editar-tarefa-projeto' style='float:right; padding-right:5px' projeto-tarefa-id='".$rs[Projeto_Tarefa_ID]."' title='Editar'>&nbsp;</div>												<input type='hidden' id='tarefa-id-".$rs[Projeto_Tarefa_ID]."' value='".$rs[Tarefa_ID]."'/>												<input type='hidden' id='grupo-responsavel-id-".$rs[Projeto_Tarefa_ID]."' value='".$rs[Grupo_Responsavel_ID]."'/>												<input type='hidden' id='usuario-responsavel-id-".$rs[Projeto_Tarefa_ID]."' value='".$rs[Usuario_Responsavel_ID]."'/>												<input type='hidden' id='tempo-execucao-".$rs[Projeto_Tarefa_ID]."' value='".$rs[Tempo_Execucao]."'/>												<input type='hidden' id='posicao-".$rs[Projeto_Tarefa_ID]."' value='".$rs[Posicao]."'/>											</p>";				$ultimaPosicaoTarefa = $rs[Posicao];			}			$largura = "100%";			$colunas = "6";			$dados[colunas][tamanho][1] = "";			$dados[colunas][tamanho][2] = "width='25%'";			$dados[colunas][tamanho][4] = "width='20%'";			$dados[colunas][tamanho][5] = "width='10%'";			$dados[colunas][tamanho][6] = "width='50px'";			$dados[colunas][titulo][1] 	= "Tarefa";			$dados[colunas][titulo][2] 	= "Grupo Respons&aacute;vel";			$dados[colunas][titulo][3] 	= "Usuário Respons&aacute;vel";			$dados[colunas][titulo][4] 	= "<p align='center'>Tempo execu&ccedil;&atilde;o</p>";			$dados[colunas][titulo][5] 	= "<p align='center'>Posi&ccedil;&atilde;o</p>";			if($i==0){				$dados[colunas][colspan][1][1] = "5";				$dados[colunas][conteudo][1][1] =  "<p Style='margin:2px 5px 0 5px; text-align:center'>Nenhum registro localizado</p>";			}			if ($projetoTarefaID=="")				$posicaoTarefa = ($ultimaPosicaoTarefa + 1);		}	}	$opcoesTarefas = optionValueTarefa($tarefaID);	$opcoesModulos = optionValueModulosProjeto($funcionalidade);	echo "	<input type='hidden' id='acao' name='acao'/>			<input type='hidden' id='projeto-tarefa-id' name='projeto-tarefa-id' value='$projetoTarefaID'/>			<input type='hidden' id='posicao-tarefa-default' name='posicao-tarefa-default' value='$posicaoTarefa'/>			<div class='titulo-container grupo1'>				<div class='titulo-container-interno'>					<div class='titulo'>						<p>							Dados Projeto";	if (($situacaoProjeto=="1") || ($situacaoProjeto=="")) echo "<input type='button' value='Salvar' id='salvar-projeto' Style='width:080px;float:right; margin-right:0px;'>";	if ($situacaoProjeto=="1") echo "<input type='button' value='Desativar' id='desativar-projeto' Style='width:080px;float:right; margin-right:0px;background-color:#E58989;'>";	if ($situacaoProjeto=="3") echo "<input type='button' value='Excluir' id='excluir-projeto' Style='width:080px;float:right; margin-right:0px;background-color:#E58989;'>";	if ($situacaoProjeto=="3") echo "<input type='button' value='Reativar' id='reativar-projeto' Style='width:080px;float:right; margin-right:0px;'>";	echo "						</p>					</div>					<div class='conteudo-interno'>						<div class='titulo-secundario' style='float:left; width:10%;'>							<p>ID</p>							<p><input type='text' id='projeto-id' name='projeto-id' value='$projetoID' style='width:90%' readonly/></p>						</div>						<div class='titulo-secundario' style='float:left; width:40%;'>							<p>T&iacute;tulo</p>							<p><input type='text' id='titulo' name='titulo' value='$titulo' style='width:97.5%' class='required-p'/></p>						</div>						<div class='titulo-secundario' style='float:left; width:30%;'>							<p>M&oacute;dulo Destino</p>							<p>								<select id='tabela-estrangeira' name='tabela-estrangeira' class='required-p' style='width:95%'>									<option value=''></option>									$opcoesModulos								</select>							</p>						</div>						<div class='titulo-secundario' style='float:left; width:20%;'>							<p>&nbsp;</p>							<p> <input type='checkbox' id='projeto-padrao' name='projeto-padrao' value='1' $projetoPadrao/> Projeto Padr&atilde;o do M&oacute;dulo</p>						</div>						<div class='titulo-secundario' style='float:left; width:100%;margin-top:10px;'>							<p>Descri&ccedil;&atilde;o detalhada do projeto</p>							<p><textarea type='text' id='descricao' name='descricao' style='width:99%; height:50px;'>$descricao</textarea></p>						</div>					</div>			</div>			</div>";	tinyMCE('descricao','');
	if ($projetoID!=""){		echo "	<div class='titulo-container grupo2'>					<div class='titulo-container-interno'>						<div class='titulo'>							<p>								Tarefas do projeto								<input type='button' value='Incluir Tarefa' class='exibir-tarefa-projeto' Style='width:080px;float:right; margin-right:0px'>							</p>						</div>					</div>					<div class='conteudo-interno $escondeTarefa' id='incluir-editar-tarefa-projeto'>						<div class='titulo-secundario' style='float:left; width:30%;'>							<p>Tarefa</p>							<p>								<select id='seleciona-tarefa-id' name='seleciona-tarefa-id' class='required' style='width:95%'>									<option value=''></option>									$opcoesTarefas								</select>							</p>						</div>						<div class='titulo-secundario' style='float:left; width:20%;'>							<p>Grupo Respons&aacute;vel</p>							<p>								<select id='grupo-responsavel' name='grupo-responsavel' class='required select-grupo-atualiza-usuarios' style='width:92%' campo='usuario-responsavel'>									<option value=''></option>";	echo optionValueGruposAcessos($grupoResponsavelID, "");	echo "						</select>							</p>						</div>						<div class='titulo-secundario' style='float:left; width:20%;'>							<p>Usuário Respons&aacute;vel</p>							<p>								<select id='usuario-responsavel' name='usuario-responsavel' class='' style='width:92%'>									<option value=''></option>";	echo optionValueUsuarios($responsavelID, $grupoResponsavelID, "");	echo "						</select>							</p>						</div>						<div class='titulo-secundario' style='float:left; width:10%;'>							<p>Tempo de execu&ccedil;&atilde;o</p>							<p><input type='text' id='tempo-execucao' name='tempo-execucao' value='$tempoExecucao' class='formata-numero required' style='width:95%'/></p>						</div>						<div class='titulo-secundario' style='float:left; width:10%;'>							<p>Posi&ccedil;&atilde;o</p>							<p><input type='text' id='posicao-tarefa' name='posicao-tarefa' value='$posicaoTarefa' class='formata-numero required' style='width:97%'/></p>						</div>						<div class='titulo-secundario' style='float:left; width:10%; margin-top:15px'>							<p align='right'>								<input type='button' value='Cancelar' class='cancelar-tarefa-projeto' Style='width:45%; margin-right:2px'>								<input type='button' value='Incluir' class='salvar-tarefa-projeto' Style='width:45%; '>							</p>						</div>						<div class='titulo-secundario div-detalhes-tarefas' style='float:left; width:100%; margin-top:15px'></div>					</div>					<div class='conteudo-interno' id='bloco-tarefas-cadastradas-projeto'>";		geraTabela($largura,$colunas,$dados, null, 'projetos-tarefas-listagem', 2, 2, '','');		echo "		</div>				</div>";	}?>