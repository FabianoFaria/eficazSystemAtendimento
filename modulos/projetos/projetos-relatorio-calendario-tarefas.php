<?phpglobal $dadosUserLogin, $caminhoSistema;$modulos = arrayModulosProjetoDescricao();$data = get_date();if ($_POST){	$responsavelID = $_POST['responsavel'];	$grupoID = $_POST['grupo'];	$situacaoID = $_POST['situacao'];	$tipoTarefaID = $_POST['tipo-tarefa'];}else{	$responsavelID = $dadosUserLogin['userID'];	$grupoID = $dadosUserLogin['grupoID'];	$situacaoID = "83";}$fechado = "#e2fae2;";$aberto  = "#F0F8FF;";echo "		<input type='hidden' name='mes' id='mes-calendario' value='".$_POST['mes']."'>		<input type='hidden' name='ano' id='ano-calendario' value='".$_POST['ano']."'>		<input type='hidden' name='workflow-id' id='workflow-id'>		<div class='titulo-container'>			<div class='titulo'>				<p>					Filtros de Pesquisa					<!--<input type='button' class='incluir-tarefa-agenda-pessoal' value='Incluir Tarefa Agenda Pessoal' style='width:160px'/>-->				</p>			</div>			<div class='conteudo-interno'>				<div class='titulo-secundario cinco-colunas'>					<p>Grupo Respons&aacute;vel:</p>					<p>						<select id='grupo' name='grupo' Style='width:98.5%' class='select-grupo-atualiza-usuarios' campo='responsavel'>							".optionValueGruposAcessos($grupoID, "", "Todos")."						</select>					</p>				</div>				<div class='titulo-secundario cinco-colunas'>					<p>Respons&aacute;vel:</p>					<p>						<select id='responsavel' name='responsavel' Style='width:98.5%'>							".optionValueUsuarios($responsavelID, "", "","Todos")."						</select>					</p>				</div>				<div class='titulo-secundario' style='float:left;width:20%;'>					<p>Tarefa</p>					<p>						<select name='tipo-tarefa' id='tipo-tarefa'>							<option value=''>Todas</option>							".optionValueTarefa($tipoTarefaID)."						</select>					</p>				</div>				<div class='titulo-secundario cinco-colunas'>					<p>Situa&ccedil;&atilde;o Tarefa</p>					<p><select name='situacao' id='situacao'>".optionValueGrupo(41, $situacaoID, "Todas")."</select></p>				</div>				<div class='titulo-secundario' style='float:right;width:20%; margin-top:25px'>					<p>						<span style='width:50px;background-color:".$aberto."'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>Aberta						&nbsp;&nbsp;&nbsp;						<span style='width:50px;background-color:".$fechado."'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>Finalizada					</p>				</div>				<div class='titulo-secundario cinco-colunas' Style='margin-top:15px; float:left;'>					<p class='direita'><input type='button' Style='width:140px;' value='Pesquisar' id='botao-pesquisar-calendario'></p>				</div>			</div>		</div>		<table width='100%' border='0' cellspacing='0' cellpadding='1' Style='margin-top:5px;'>			<tr>				<td width='50%' valign='top'>					<table width='100%' border='0' cellpadding='1' cellspacing='0' class='txtAgenda'>						<tr>							<td colspan='7' height='39' Style='border:1px solid #DCDCDC;background:#f6f6f6;padding:2px;'>								<table width='100%' height='39' border='0' cellspacing='0' cellpadding='1'>									<tr>										<td width='50' align='center'><a href='#' attr-mes-ano='".mesAno(-1)."' class='calendario-mes'>											<img src='".$caminhoSistema."/images/geral/anterior.png' alt='anterior' name='anterior' width='20' height='20' id='anterior' style='margin-top:3px;'></a>										</td>										<td align='center' Style='font-size:16px'><b>".getDiaMesAno()."</b></td>										<td width='50' align='center'><a href='#' attr-mes-ano='".mesAno(1)."'  class='calendario-mes'>											<img src='".$caminhoSistema."/images/geral/proximo.png' alt='proximo' name='proximo' width='20' height='20' id='proximo' Style='margin-top:3px;'></a>										</td>									</tr>								</table>							</td>						</tr>						<tr>							<td>";$mesAno = get_date();$mes = $mesAno['mes'];$ano = $mesAno['ano'];if ($grupoID!="")	$sqlCond = " and vt.Grupo_Responsavel_ID = '$grupoID' ";if ($responsavelID!="")	$sqlCond = " and vt.Usuario_Responsavel_ID = '$responsavelID' ";if ($solicitanteID!="")	$sqlCond .= " and v.Usuario_Cadastro_ID = '$solicitanteID' ";if ($situacaoID!="")	$sqlCond .= " and vt.Situacao_ID = '$situacaoID' ";if ($tipoTarefaID!="")	$sqlCond .= " and vt.Tarefa_ID = '$tipoTarefaID' ";$dataInicio = "'".$ano."-".$mes."-01 00:00:00'";$ultimoDia = date("t", mktime(0,0,0,$mes,'01',$ano));$dataFim = "'".$ano."-".$mes."-".$ultimoDia." 23:59:59'";$sql = "SELECT vt.Projeto_Vinculo_ID AS Workflow_ID, t.Titulo AS Tipo_Tarefa, vt.Projeto_Vinculo_Tarefa_ID,		DATE_FORMAT(vt.Data_Limite,'%d/%m/%Y') AS Data_Retorno, DATE_FORMAT(vt.Data_Limite,'%H:%i') AS Hora_Retorno, cd2.Nome AS Cadastro,		COALESCE(r.Nome,ma.Titulo) AS Responsavel, ts.Descr_Tipo AS Situacao, vt.Situacao_ID AS Situacao_ID,		vt.Tabela_Estrangeira, vt.Chave_Estrangeira, vt.Campo_Estrangeiro, t.Dados as Dados_Tarefa		FROM  projetos_vinculos_tarefas vt 		left JOIN projetos_vinculos v ON vt.Projeto_Vinculo_ID = v.Projeto_Vinculo_ID		left JOIN tarefas t ON t.Tarefa_ID = vt.Tarefa_ID		left JOIN modulos_acessos ma ON ma.Modulo_Acesso_ID = vt.Grupo_Responsavel_ID		left JOIN cadastros_dados cd2 ON cd2.Cadastro_ID = vt.Usuario_Cadastro_ID		left JOIN tipo ts ON ts.Tipo_ID = vt.Situacao_ID		LEFT JOIN cadastros_dados r ON r.Cadastro_ID = vt.Usuario_Responsavel_ID		where vt.Data_Limite between $dataInicio and $dataFim		$sqlCond		order by vt.Data_Limite";//echo $sql;$resultado = mpress_query($sql);$i = 0;while($row = mpress_fetch_array($resultado)){	//$dadosProcesso = mpress_fetch_array(mpress_query("select Titulo from $row[Tabela_Estrangeira] where $row[Campo_Estrangeiro] = $row[Chave_Estrangeira]"));	$i++;	$dataAtual = $row['Data_Retorno'];	if($dataAtual != $dataAnterior) $i=1;	$tarefas[$row['Data_Retorno']][$i][tarefaID]			= $row['Projeto_Vinculo_Tarefa_ID'];	$tarefas[$row['Data_Retorno']][$i][id] 				= $row['Workflow_ID'];	$tarefas[$row['Data_Retorno']][$i][modulo] 			= $modulos[$row[Tabela_Estrangeira]];	$tarefas[$row['Data_Retorno']][$i][tarefa] 			= $row['Tipo_Tarefa'];	$tarefas[$row['Data_Retorno']][$i][chaveEstrangeira] 	= $row['Chave_Estrangeira'];	$tarefas[$row['Data_Retorno']][$i][hora]		= $row['Hora_Retorno'];	$tarefas[$row['Data_Retorno']][$i][cadastro]		= $row['Cadastro'];	$tarefas[$row['Data_Retorno']][$i][responsavel]	= $row['Responsavel'];	$tarefas[$row['Data_Retorno']][$i][situacaoID]	= $row['Situacao_ID'];	$tarefas[$row['Data_Retorno']][$i][situacao]		= $row['Situacao'];	$tarefas[$row['Data_Retorno']][$i][titulo]		= $dadosProcesso['Titulo'];	$tarefas[$row['Data_Retorno']][$i][origem]		= $row['Tabela_Estrangeira'];	$tarefas[$row['Data_Retorno']][$i][dadosTarefa]		= unserialize($row['Dados_Tarefa']);	$dataAnterior = $dataAtual;	if ($row['Tabela_Estrangeira']=="orcamentos_workflows"){		$sql = "Select cd.Nome, ow.Solicitante_ID, ow.Titulo from orcamentos_workflows ow													inner join cadastros_dados cd on cd.Cadastro_ID = ow.Solicitante_ID											where Workflow_ID = '".$row['Chave_Estrangeira']."'";		//echo "<br>".$sql;		$resultSet = mpress_query($sql);		$rsA = mpress_fetch_array($resultSet);		$solicitante = $rsA['Nome'];		$cadastroTarefaID = $rsA['Solicitante_ID'];		$titulo = $rsA['Titulo'];	}	if ($row['Tabela_Estrangeira']=="chamados_workflows"){		$sql = "Select cd.Nome, cw.Solicitante_ID, cw.Titulo from chamados_workflows cw											inner join cadastros_dados cd on cd.Cadastro_ID = cw.Solicitante_ID											 where Workflow_ID = '".$row['Chave_Estrangeira']."'";		//echo "<br>".$sql;		$resultSet = mpress_query($sql);		$rsA = mpress_fetch_array($resultSet);		$solicitante = $rsA['Nome'];		$cadastroTarefaID = $rsA['Solicitante_ID'];		$titulo = $rsA['Titulo'];	}	$tarefas[$row['Data_Retorno']][$i][solicitante] = $solicitante;}/*echo "<pre>";print_r($tarefas);echo "</pre>";*/$numero_dias = getNumeroDias($mes);$diacorrente = 0;$diasemana = jddayofweek(cal_to_jd(CAL_GREGORIAN, $mes,"01",date('Y')),0);	// função que descobre o dia da semana//echo $diasemana;$texto .= "	<table border='0' cellspacing='0' width='100%'>				<tr class='linha_semanas' height='40'>					".mostraSemanas()."				</tr>";for($linha=0;$linha<6;$linha++ ){   $texto .= "<tr  height='90'>";   for($coluna=0;$coluna<7;$coluna++){		$texto .= "<td align='left' valign='top'";		$classeRight = "";		if ((($coluna + 1) % 7)==0) $classeRight = " bordaRight";		if(($diacorrente==(date('d')-1)&&date('m')==$mes)){			$incrementoDia = 0;			if($_POST['dia']==""){				$texto .= "class='DiaSelecionado-adm $classeRight'";				$incrementoDia = 1;			}else				$texto .= "class='bordaLatlInf $classeRight'";		}else{			if(($diacorrente + 1) <= $numero_dias ){				$dia = $diacorrente+1;				$dataAtual = $dia."/".$mesAno['mes']."/".$mesAno['ano'];				if($_POST['dia']==$dia+1){					$texto .= "class='DiaSelecionado $classeRight'";				}else{					$texto .= "class='bordaLatlInf bordaLeft $classeRight'";				}			 }else{				if ($diacorrente==$numero_dias){					$texto .= "class='bordaLeft'";				}			 }		}		$texto .= " >";		if($diacorrente + 1 <= $numero_dias ){			if($coluna < $diasemana && $linha == 0){				$texto .= "&nbsp;";			}else{				$texto .= "<div Style='margin-top:3px;margin-left:3px'>".++$diacorrente."</div>";			}		}else{			break;		}		$dia = $diacorrente;		if(strlen($dia)==1) $dia = "0$dia";		$dataTarefa = $dia."/".$mesAno['mes']."/".$mesAno['ano'];		for($c=1;$c<=count($tarefas[$dataTarefa]);$c++){			if ($tarefas[$dataTarefa][$c][situacaoID]=='83') $color = "$aberto"; else $color = "$fechado";			$corFundo = $corTexto = "";			if ($tarefas[$dataTarefa][$c]['dadosTarefa']['cor-fundo']!=''){				$corFundo = "background-color:".$tarefas[$dataTarefa][$c]['dadosTarefa']['cor-fundo'];			}			if ($tarefas[$dataTarefa][$c]['dadosTarefa']['cor-texto']!=''){				$corTexto = "color:".$tarefas[$dataTarefa][$c]['dadosTarefa']['cor-texto'];			}			if($tarefas[$dataTarefa][$c]['titulo'] != "")				$tituloTarefa = $tarefas[$dataTarefa][$c]['titulo']."<br>";			else				$tituloTarefa = "";			$texto .= "	<fieldset style='background-color:$color; width:97%;padding:0.5%;margin-left:0.5%;margin-bottom:2px;float:left;' title='Respons&aacute;vel ".$tarefas[$dataTarefa][$c][responsavel]."'>							<legend class='link-projeto-tarefa' workflow-id='".$tarefas[$dataTarefa][$c][chaveEstrangeira]."' origem='".$tarefas[$dataTarefa][$c]['origem']."'>									&nbsp;									<b class='link'>".$tarefas[$dataTarefa][$c][modulo]."&nbsp;- ".$tarefas[$dataTarefa][$c][chaveEstrangeira]."</b>							</legend>							<div Style='float:left;width:97%;padding:3px;'>								".$tarefas[$dataTarefa][$c][solicitante]."							</div>							<div Style='float:left;width:97%;padding:3px;'>								<a class='fancybox fancybox.iframe' href='$caminhoSistema/modulos/projetos/projetos-follows-tarefas.php?wID=".$tarefas[$dataTarefa][$c][id]."&t=".$tarefas[$dataTarefa][$c][tarefaID]."' id='tarefa-edita-".$tarefas[$dataTarefa][$c][tarefaID]."'>									<div class='btn-editar' style='float:right;' title='Editar'>&nbsp;</div>								</a>								<b> <span style='font-size: 15px;'>".$tarefas[$dataTarefa][$c][hora]." </span> -									<span style='padding:1px;".$corFundo." ; ".$corTexto.";'>									".$tarefas[$dataTarefa][$c][tarefa]."									</span>								</b>								<br>								$tituloTarefa								Respons&aacute;vel: ".$tarefas[$dataTarefa][$c][responsavel]."<br>							</div>					   </fieldset> ";		}		$incrementoDia = "";		$texto .= "</td>";	}	$texto .= "</tr>";}$texto .= "</table>";echo $texto;echo "				</td>				</tr>			</table>		</td>	</tr></table>";function getDiaMesAno(){	$data = get_date();	if($_POST['dia'] != "") $dia = $_POST['dia']; else $dia = date('d');	return mostraMeses($data[mes])." DE ".$data['ano'];}function get_date(){	$data[dia] = $_POST['dia'];	$data[mes] = $_POST['mes'];	$data[ano] = $_POST['ano'];	if(strlen($data[dia])==1)$data[dia]="0".$data[dia];	if($data[mes]=="") $data[mes] = date('m');	if($data[ano]=="") $data[ano] = date('Y');	return $data;}function mostraSemanas(){	$semana[0] = 'Dom';	$semana[1] = 'Seg';	$semana[2] = 'Ter';	$semana[3] = 'Qua';	$semana[4] = 'Qui';	$semana[5] = 'Sex';	$semana[6] = 'Sab';	for($i=0;$i<7;$i++ ){		if ($i==6){			$classeRight = " bordaRight";		}		$diasSemana .=  "<td align='center' valign='middle' class='bordaSemanaLatlInf bordaSemanaLeft $classeRight' width='14.28%'>".$semana[$i]."</td>";	}	return $diasSemana;}function mostraMeses($entrada){	$mes['01'] = 'JANEIRO';	$mes['02'] = 'FEVEREIRO';	$mes['03'] = 'MAR&Ccedil;O';	$mes['04'] = 'ABRIL';	$mes['05'] = 'MAIO';	$mes['06'] = 'JUNHO';	$mes['07'] = 'JULHO';	$mes['08'] = 'AGOSTO';	$mes['09'] = 'SETEMBRO';	$mes['10'] = 'OUTUBRO';	$mes['11'] = 'NOVEMBRO';	$mes['12'] = 'DEZEMBRO';	return $mes[$entrada];}function mesAno($tipo){	$mesAno = get_date();	$data['mes'] = $mesAno['mes'];	$data['ano'] = $mesAno['ano'];	$data['mes'] = $data['mes']+$tipo;	if($data['mes']==13){$data['mes'] = '01';$data['ano']=$data['ano']+1;}	if($data['mes']==00){$data['mes'] = '12';$data['ano']=$data['ano']-1;}	if(strlen($data['mes'])==1)$data['mes'] = "0".$data['mes'];	return $data['mes']."|".$data['ano'];}function getNumeroDias( $mes ){	$numero_dias = array('01' => 31, '02' => 28, '03' => 31, '04' =>30, '05' => 31, '06' => 30,'07' => 31, '08' =>31, '09' => 30, '10' => 31, '11' => 30, '12' => 31);	if (((date('Y') % 4) == 0 and (date('Y') % 100)!=0) or (date('Y') % 400)==0){		$numero_dias['02'] = 29;	// altera o numero de dias de fevereiro se o ano for bissexto	}	return $numero_dias[$mes];}?>