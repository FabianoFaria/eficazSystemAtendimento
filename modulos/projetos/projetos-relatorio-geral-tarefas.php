<?php	session_start();	global $dadosUserLogin;	$arrayModulo = arrayModulosProjetoDescricao();	if ($_POST){		$responsavelID = $_POST['select-responsavel'];		$grupoResponsavelID = $_POST['select-grupo-responsavel'];		$solicitanteID = $_POST['select-solicitante'];		$situacaoID = $_POST['select-situacao'];		$tipoTarefaID = $_POST['select-tipo-tarefa'];		$dataInicio = $_POST['data-inicio-retorno'];		$dataFim = $_POST['data-fim-retorno'];	}	else{		$responsavelID = $dadosUserLogin['userID'];		$situacaoID = "83";	}	if ($_POST['select-agrupar']=='') $_POST['select-agrupar'] = 'tarefa';	$fechado = "#e2fae2;";	$aberto  = "#F0F8FF;";?><div class="titulo-container">	<div class="titulo" style="min-height:25px">		<p style="margin-top:2px;">		Filtros de Pesquisa		</p>	</div>	<div class="conteudo-interno">		<div class="titulo-secundario" style="float:left;width:	25%;">			<p>Agrupar por:</p>			<p style="min-height:26px;padding-top:7px;">				<input type='radio' name='select-agrupar' id='select-agrupar-t' value='tarefa' 		<?php if ($_POST['select-agrupar'] == "tarefa") echo " checked ";?>/>		<label for='select-agrupar-t'> Por Tarefa </label>				<!--				<input type='radio' name='select-agrupar' id='select-agrupar-s' value='solicitante' <?php if ($_POST['select-agrupar'] == "solicitante") echo " checked ";?>/>	<label for='select-agrupar-s'> Por Solicitante </label>				<input type='radio' name='select-agrupar' id='select-agrupar-r' value='responsavel' <?php if ($_POST['select-agrupar'] == "responsavel") echo " checked ";?>/>	<label for='select-agrupar-r'> Por Responsável </label>				-->			</p>		</div><?php	/*	echo "	<div class='titulo-secundario' style='float:left;width:20%;'>				<p>Grupo Respons&aacute;vel Tarefa:</p>				<p>					<select name='select-grupo-responsavel' id='select-grupo-responsavel'>						<option></option>						".optionValueGruposAcessos($grupoResponsavelID, "","0")."					</select>				</p>			</div>";	*/	echo "	<div class='titulo-secundario' style='float:left;width:25%;'>				<p>Respons&aacute;vel Tarefa:</p>				<p>					<select name='select-responsavel' id='select-grupo-responsavel'>					".optionValueUsuarios($responsavelID, $grupoResponsavelID, "")."					</select>				</p>			</div>";	echo "	<div class='titulo-secundario' style='float:left;width:25%;'>				<p>Solicitante Tarefa:</p>				<p>					<select name='select-solicitante' id='select-grupo-responsavel'>					".optionValueUsuarios($solicitanteID, $grupoResponsavelID, "")."					</select>				</p>			</div>";?><!--		<div class="titulo-secundario" style="float:left;width:60%;height:50px">			<p>&nbsp;</p>			<p class='exibe-graficos'><input type='checkbox' name='exibir-graficos' id='exibir-graficos' value='1' <?php if ($_POST['exibir-graficos']==1) echo " checked "; ?>/> Exibir Gr&aacute;ficos</p>		</div>-->		<div class='titulo-secundario' style='float:left;width:25%;'>			<p>Tarefa</p>			<p>				<select name='select-tipo-tarefa' id='select-tipo-tarefa'>					<option value=''>Todas</option>					<?php echo optionValueTarefa($tipoTarefaID);?>				</select>			</p>		</div>		<div class="titulo-secundario" style="float:left;width:25%;">			<p>Data Retorno:</p>			<div style='width:43%;float:left;'>				<p><input type='text' name='data-inicio-retorno' id='data-inicio-retorno' class='formata-data' style='width:95%' maxlength='10' value='<?php echo $_POST['data-inicio-retorno']; ?>'>&nbsp;&nbsp;</p>			</div>			<div style='width:10%;text-align:center;float:left;'><p>a</p></div>			<div style='width:43%;float:left;'>				<p><input type='text' name='data-fim-retorno' id='data-fim-retorno' class='formata-data' style='width:95%' maxlength='10' value='<?php echo $_POST['data-fim-retorno'] ?>'></p>			</div>		</div>		<div class="titulo-secundario" style="float:left;width:25%;">			<p>Situa&ccedil;&atilde;o Tarefa</p>			<p><select name='select-situacao' id='select-situacao'><?php echo optionValueGrupo(41, $situacaoID, "Todas"); ?></select></p>		</div>		<!--		<div class='titulo-secundario' style='float:left;width:10%;'>			<p style='padding-top:10px;'>				<span style='width:50px;background-color:<?php echo $aberto; ?>'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> Aberta				&nbsp;&nbsp;&nbsp;				<span style='width:50px;background-color:<?php echo $fechado; ?>'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> Finalizada			</p>		</div>		-->		<div class='titulo-secundario' Style='float:right;width:25%; margin-top:15px; margin-bottom:10px;'>			<p class='direita'><input type='button' Style='width:140px; float:right;' value='Pesquisar' id='botao-pesquisar-calendario'></p>		</div>	</div></div><input type='hidden' name='workflow-id' id='workflow-id'><?php	//if ($_POST){		if ($responsavelID!="")			$sqlCond .= " and vt.Usuario_Responsavel_ID = '$responsavelID' ";		if ($solicitanteID!="")			$sqlCond .= " and vt.Usuario_Cadastro_ID = '$solicitanteID'";		if ($situacaoID!="")			$sqlCond .= " and vt.Situacao_ID = '$situacaoID'";		if ($tipoTarefaID!="")			$sqlCond .= " and vt.Tarefa_ID = '$tipoTarefaID'";		if(($dataInicio!="")||($dataFim!="")){			$dataInicio = implode('-',array_reverse(explode('/',$dataInicio)));			if ($dataInicio=="") $dataInicio = "0000-00-00"; $dataInicio .= " 00:00";			$dataFim = implode('-',array_reverse(explode('/',$dataFim)));			if ($dataFim=="") $dataFim = "2100-01-01"; $dataFim .= " 23:59";			//$sqlCond .= " and t.Data_Retorno between '$dataInicio' and '$dataFim' ";			$sqlCond .= " and vt.Data_Limite between $dataInicio and $dataFim";		}		if ($_POST['select-agrupar'] == "tarefa"){			$colunas = "7";			$sql = "SELECT vt.Tabela_Estrangeira,					/*vt.Projeto_Vinculo_ID AS Workflow_ID, */					vt.Chave_Estrangeira AS Workflow_ID,					t.Titulo AS Tipo_Tarefa, vt.Projeto_Vinculo_Tarefa_ID,					s.Nome AS Cadastro,					a.Nome AS Alvo,					r.Nome AS Responsavel,					ts.Descr_Tipo AS Situacao,					vt.Situacao_ID AS Situacao_ID,					vt.Tabela_Estrangeira, vt.Chave_Estrangeira,					vt.Campo_Estrangeiro, t.Dados as Dados_Tarefa,					DATE_FORMAT(vt.Data_Limite,'%d/%m/%Y') AS Data_Retorno,					DATE_FORMAT(vt.Data_Limite,'%H:%i') AS Hora_Retorno,					SUM(TIME_TO_SEC(timediff(vtf.Hora_Fim, vtf.Hora_Inicio))) as Segundos_Diferenca					FROM projetos_vinculos_tarefas vt					left JOIN projetos_vinculos v ON vt.Projeto_Vinculo_ID = v.Projeto_Vinculo_ID					left JOIN tarefas t ON t.Tarefa_ID = vt.Tarefa_ID					left JOIN modulos_acessos ma ON ma.Modulo_Acesso_ID = vt.Grupo_Responsavel_ID					left JOIN tipo ts ON ts.Tipo_ID = vt.Situacao_ID					left JOIN cadastros_dados r ON r.Cadastro_ID = vt.Usuario_Responsavel_ID					left JOIN cadastros_dados s ON s.Cadastro_ID = vt.Usuario_Cadastro_ID					left JOIN cadastros_dados a ON a.Cadastro_ID = vt.Cadastro_Alvo_ID					left join projetos_vinculos_tarefas_follows vtf on vt.Projeto_Vinculo_Tarefa_ID = vtf.Projeto_Vinculo_Tarefa_ID					where vt.Projeto_Vinculo_Tarefa_ID > 0					$sqlCond					group by vt.Projeto_Vinculo_Tarefa_ID					order by vt.Data_Limite";			//echo $sql;			$resultado = mpress_query($sql);			$i = 0;			while($row = mpress_fetch_array($resultado)){				$c=1;				$i++;				$dadosTarefa = unserialize($row['Dados_Tarefa']);				$corFundo = $corTexto = "";				if ($dadosTarefa['cor-fundo']!='') $corFundo = "background-color:".$dadosTarefa['cor-fundo'].";";				if ($dadosTarefa['cor-texto']!='') $corTexto = "color:".$dadosTarefa['cor-texto'].";";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;' class='link link-projeto-tarefa' workflow-id='".$row['Workflow_ID']."' origem='".$row['Tabela_Estrangeira']."'>".$arrayModulo[$row['Tabela_Estrangeira']]." - ".$row['Workflow_ID']."</p>";				$dados[colunas][extras][$i][$c] .= " style='".$corTexto."; ".$corFundo.";'";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".$row['Tipo_Tarefa']."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".$row['Alvo']."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".$row['Responsavel']."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".$row['Data_Retorno']." ".$row['Hora_Retorno']."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".$row['Cadastro']."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".$row['Situacao']."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 3px 0 3px;float:left;'>".retornaHorasMinutos($row['Segundos_Diferenca'])."</p>";			}			$c=1;			$dados[colunas][titulo][$c++] = "M&oacute;dulo / ID";			$dados[colunas][titulo][$c++] = "Tarefa";			$dados[colunas][titulo][$c++] = "Alvo";			$dados[colunas][titulo][$c++] = "Respons&aacute;vel Tarefa";			$dados[colunas][titulo][$c++] = "Data Limite";			$dados[colunas][titulo][$c++] = "Solicitante";			$dados[colunas][titulo][$c++] = "Situa&ccedil;&atilde;o";			$dados[colunas][titulo][$c++] = "Horas Trabalho";		}		echo "	<div>					<div class='titulo-container'>						<div class='titulo'>							<p>Registros Localizados: $i</p>						</div>						<div class='conteudo-interno'>";		if ($i==0){			echo "<p Style='margin:2px 5px 0 5px; text-align:center'>Nenhuma registro encontrado</p>";		}		else{			geraTabela('100%',($c - 1),$dados, null, 'relatorio-geral-de-tarefas', 2, 2, 100,1);		}		echo "			</div>					</div>				</div>";function retornaHorasMinutos($segundos){	$e = ""; $tempo = "";	$horas =  (int)($segundos/ 3600);	$minutos =  (int)(($segundos % 3600)/60);	if (($horas==0) && ($minutos==0)) $tempo = "";	else{		if ($horas!=0){ $tempo .= "$horas horas"; $e = " e "; }		if ($minutos!=0) $tempo .= $e."$minutos minutos";	}	return $tempo;}?>