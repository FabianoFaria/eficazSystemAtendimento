<?php	session_start();	error_reporting(E_ERROR);	ini_set('display_errors', 'On');	if (!(function_exists("get_header")))		require_once("../../includes/functions.gerais.php");	if (!(function_exists("mpress_query")))		require_once("../../config.php");	global $configProdutos;	$configProdutos = carregarConfiguracoesGeraisModulos('produtos');	function carregarFornecedores(){		$produtoID = $_GET['produto-id'];		echo "<div class='div-vincular-cadastros' Style='float:left;width:100%;margin-bottom:5px;'>";		carregarBlocoCadastroGeral("", 'fornecedor-id', 'Cadastro', 0,'','');		echo "</div>			  <div class='div-cadastros-vinculados'>";		$sql = "select cd.Cadastro_ID as Cadastro_ID, tp.Descr_Tipo as Tipo_Pessoa, tc.Descr_Tipo as Tipo_Cadastro_Descr, Nome, Nome_Fantasia, Senha, Data_Nascimento, Cpf_Cnpj,				Inscricao_Municipal, Inscricao_Estadual, cd.Usuario_Cadastro_ID, Codigo, coalesce(cf.Telefone,'') as Telefone, cf.Observacao, cd.Email as Email,				pf.Produto_Cadastro_ID as Parametro				from cadastros_dados cd				inner join produtos_fornecedores pf on pf.Cadastro_ID = cd.Cadastro_ID				left join cadastros_telefones cf on cf.Cadastro_ID = cd.Cadastro_ID and cf.Situacao_ID = 1				left join tipo tp on Tipo_ID = Tipo_Pessoa and tp.Tipo_Grupo_ID = 8				left join tipo tc on tc.Tipo_ID = Tipo_Cadastro and tc.Tipo_Grupo_ID = 9				where cd.Situacao_ID = 1				and pf.Produto_ID = '$produtoID'				and pf.Situacao_ID = 1				and cd.Cadastro_ID > 0				order by Nome, cd.Cadastro_ID";		carregarListagemCadastrosGeral($sql, $tipoVinculoID);		echo "</div>";	}	function localizaCadastrosSelect(){		$descricao = $_GET['descricao'];		$produtoID = $_GET['produto-id'];		if ($descricao!=""){			$sqlCond = " and (Nome like '%$descricao%' or Nome_Fantasia like '%$descricao%' or Cpf_Cnpj like '%$descricao%')";		}		$sql = "select Cadastro_ID, Nome, Nome_Fantasia, Cpf_Cnpj					from cadastros_dados cd					where cd.Situacao_ID = 1					and Cadastro_ID NOT IN (select pf.Cadastro_ID from produtos_fornecedores pf where pf.Produto_ID = $produtoID)					$sqlCond ";		echo "<select id='select-novo-vinculo' name='select-novo-vinculo'>					<option value=''>Selecione</option>";		$resultado = mpress_query($sql);		while($row = mpress_fetch_array($resultado)){			echo "<option value='".$row[Cadastro_ID]."'>".utf8_encode($row[Nome])."</option>";		}		echo "</select>";	}	/********************************* Inicio Funções de BANCO DE DADOS Vinculos *********************************/	function inserirFornecedorProduto(){		$cadastroID = $_GET['cadastro-id'];		$produtoID = $_GET['produto-id'];		$sql = "Insert Into produtos_fornecedores (Cadastro_ID, Produto_ID, Situacao_ID)									     Values ('$cadastroID', '$produtoID', 1)";		echo $sql;		mpress_query($sql);	}	function excluirFornecedorProduto(){		$produtoCadastroID = $_GET['produto-cadastro-id'];		$sql = "delete from produtos_fornecedores where Produto_Cadastro_ID = $produtoCadastroID";		mpress_query($sql);	}	/********************************* Fim Funções de BANCO DE DADOS Vinculos *********************************//********************************* Inicio Funções de BANCO DE DADOS Produtos *********************************/	function salvarProduto(){		global $dadosUserLogin;		$produtoID = $_POST['produto-id'];		$nome = utf8_decode($_POST['produto-nome']);		$codigo = utf8_decode($_POST['produto-codigo']);		$categorias = serialize($_POST['chkCategoria']);		$descricaoResumida = utf8_decode($_POST['descricao-resumida']);		$descricaoCompleta = utf8_decode($_POST['descricao-completa']);		$tipoProduto= $_POST['select-tipo-grupo-13'];		$marcaID = $_POST['marca-produto'];		$formularioID = $_POST['formulario-id'];		$industrializado = $_POST['produto-industrializado'];		$NCM = $_POST['ncm-produto'];		$origem = $_POST['origem-produto'];		$numeroSerie = $_POST['produto-numero-serie'];		$destaque = $_POST['destaque'];		$lancamento = $_POST['lancamento'];		$slug = $_POST['slug'];		$situacaoID = $_POST['situacao-id'];		if ($slug==""){			$slug=criaSlug($nome);		}		if ($produtoID==""){			$sql = "Insert Into produtos_dados (Nome, Codigo, Categorias, Descricao_Resumida, Descricao_Completa, Slug, Tipo_Produto, Marca, Formulario_ID, Industrializado, Numero_Serie, Destaque, Lancamento, Origem, NCM, Situacao_ID, Usuario_Cadastro_ID)									 Values ('$nome', '$codigo', '$categorias', '$descricaoResumida', '$descricaoCompleta', '$slug', '$tipoProduto', '$marcaID', '$formularioID', '$industrializado', '$numeroSerie', '$destaque', '$lancamento', '$origem', '$NCM', '$situacaoID', '".$dadosUserLogin[userID]."')";			mpress_query($sql);			$produtoID = mysql_insert_id();			$flagInsert = 1;			//mpress_query("delete from produtos_estoque where Produto_Variacao_ID = $produtoID");			//mpress_query("insert into produtos_estoque(Produto_Variacao_ID, Estoque_Minimo,Compra_Minima,Utilizacao_Media,Prazo_Medio_Entrega,Quantidade_Embalagem)values(".$_POST['hdProdV'].",'".$_POST['estoque-minimo']."','".$_POST['compra-minima']."','".$_POST['utilizacao-media']."','".$_POST['prazo-entrega']."','".$_POST['quantidade-embalagem']."')");		}		else{			$sql = "update produtos_dados set 	Nome = '$nome',												Descricao_Resumida = '$descricaoResumida',												Descricao_Completa = '$descricaoCompleta',												Tipo_Produto = '$tipoProduto',												Marca = '$marcaID',												Formulario_ID = '$formularioID',												Codigo = '$codigo',												Categorias = '$categorias',												Industrializado = '$industrializado',												Destaque = '$destaque',												Lancamento = '$lancamento',												NCM = '$NCM',												Origem = '$origem',												Numero_Serie = '$numeroSerie',												Slug = '$slug',												Situacao_ID = '$situacaoID'					where Produto_ID = $produtoID";			mpress_query($sql);			$sql = "select count(*) as cont from produtos_variacoes where Produto_ID = $produtoID";			$resultado = mpress_query($sql);			if($row = mpress_fetch_array($resultado)){				if ($row[cont]>0){					for($p=1;$p<=$row[cont];$p++){						$formaCobranca 	= $_POST['forma-cobranca-'.$p];						$descricaoVaricao	= utf8_decode($_POST['descricao-variacao-'.$p]);						$valorCusto 		= formataValorBD($_POST['valor-custo-variacao-'.$p]);						$valorVenda 		= formataValorBD($_POST['valor-venda-variacao-'.$p]);						$valorPromocao 	= formataValorBD($_POST['valor-promocao-variacao-'.$p]);						$percentualVenda 	= formataValorBD($_POST['percentual-venda-'.$p]);						$altura 			= formataValorBD($_POST['altura-variacao-'.$p]);						$largura 			= formataValorBD($_POST['largura-variacao-'.$p]);						$comprimento 		= formataValorBD($_POST['comprimento-variacao-'.$p]);						$peso 			= formataValorBD($_POST['peso-variacao-'.$p]);						$saldoEstoque 		= formataValorBD($_POST['saldo-estoque-variacao-'.$p]);						$unidadeVariacao 	= $_POST['unidade-'.$p];						$dataInicioPromocao = formataDataBD($_POST['data-inicio-promocao-variacao-'.$p]);						$dataFimPromocao 	= formataDataBD($_POST['data-fim-promocao-variacao-'.$p]);						$cean			= $_POST['cean-'.$p];						$produtoVariacaoID = $_POST['produto-variacao-id-'.$p];						$sql = "update produtos_variacoes set Descricao = '$descricaoVaricao', Forma_Cobranca_ID = '$formaCobranca', Unidade = '$unidadeVariacao', CEAN = '$cean',															  Valor_Custo = '$valorCusto', Valor_Venda = '$valorVenda', Valor_Promocao = '$valorPromocao', Percentual_Venda = '$percentualVenda',															  Data_Inicio_Promocao =  '$dataInicioPromocao', Data_Fim_Promocao = '$dataFimPromocao',															  Altura = '$altura', Largura = '$largura', Comprimento = '$comprimento',Peso = '$peso', Saldo_Estoque = '$saldoEstoque',															  Codigo = '".utf8_decode($_POST['codigo-variacao-'.$p])."', Imagem_ID = '".$_POST['imagem-variacao-'.$p]."'									where Produto_Variacao_ID = $produtoVariacaoID";						//echo $sql;						//exit();						mpress_query($sql);					}				}			}			//mpress_query("delete from produtos_estoque where Produto_Variacao_ID = ".$_POST['hdProdV']);			//mpress_query("insert into produtos_estoque(Produto_Variacao_ID, Estoque_Minimo,Compra_Minima,Utilizacao_Media,Prazo_Medio_Entrega,Quantidade_Embalagem)values(".$_POST['hdProdV'].",'".str_replace(",",".",str_replace(".","",$_POST['estoque-minimo']))."','".str_replace(",",".",str_replace(".","",$_POST['compra-minima']))."','".str_replace(",",".",str_replace(".","",$_POST['utilizacao-media']))."','".$_POST['prazo-entrega']."','".$_POST['quantidade-embalagem']."')");		}		if (($_POST['acao-variacao']=="I")||($flagInsert=="1")||($tipoProduto=="100")){			$p=0;			$formaCobranca 	= $_POST['forma-cobranca-'.$p];			$descricaoVaricao	= utf8_decode($_POST['descricao-variacao-'.$p]);			$valorCusto 		= formataValorBD($_POST['valor-custo-variacao-'.$p]);			$valorVenda 		= formataValorBD($_POST['valor-venda-variacao-'.$p]);			$valorPromocao 		= formataValorBD($_POST['valor-promocao-variacao-'.$p]);			$percentualVenda 	= formataValorBD($_POST['percentual-venda-'.$p]);			$altura 			= formataValorBD($_POST['altura-variacao-'.$p]);			$largura 			= formataValorBD($_POST['largura-variacao-'.$p]);			$comprimento 		= formataValorBD($_POST['comprimento-variacao-'.$p]);			$peso 				= formataValorBD($_POST['peso-variacao-'.$p]);			$saldoEstoque 		= formataValorBD($_POST['saldo-estoque-variacao-'.$p]);			$unidadeVariacao 	= $_POST['unidade-'.$p];			$dataInicioPromocao = formataDataBD($_POST['data-inicio-promocao-variacao-'.$p]);			$dataFimPromocao 	= formataDataBD($_POST['data-fim-promocao-variacao-'.$p]);			$produtoVariacaoID 	= $_POST['produto-variacao-id-'.$p];			$cean			= $_POST['cean-'.$p];			$sql = "Insert Into produtos_variacoes (Produto_ID, Descricao, Forma_Cobranca_ID, Valor_Custo, Valor_Venda, Valor_Promocao, Percentual_Venda, Data_Inicio_Promocao, Data_Fim_Promocao,													Altura, Largura, Comprimento,Peso, Saldo_Estoque, Situacao_ID, Usuario_Cadastro_ID, Codigo,Imagem_ID, Unidade, CEAN)											 Values ('$produtoID', '$descricaoVaricao', '$formaCobranca', '$valorCusto', '$valorVenda', '$valorPromocao','$percentualVenda', '$dataInicioPromocao', '$dataFimPromocao',													'$altura', '$largura', '$comprimento', '$peso', '$saldoEstoque', '1','".$dadosUserLogin[userID]."','".utf8_decode($_POST['codigo-variacao-'.$p])."','".($_POST['imagem-variacao-'.$p])."','$unidadeVariacao', '$cean')";			mpress_query($sql);			$idVariacao = mpress_identity();		}		if($tipoProduto == 100){			if ($flagInsert=="1"){				mpress_query("update produtos_compostos set Produto_Pai_ID = '$produtoID' where Produto_Pai_ID = ".($dadosUserLogin['userID'] * (-1))."");			}			mpress_query("insert into produtos_compostos(Produto_Pai_ID, Produto_Variacao_ID, Quantidade,Usuario_Cadastro_ID)						  select Produto_Pai_ID, Produto_Variacao_ID, Quantidade, ".$dadosUserLogin[userID]."						  from produtos_compostos where Situacao_ID = 1 and Produto_Pai_ID = $produtoID and Produto_Variacao_Pai_ID is not null");			mpress_query("update produtos_compostos set Situacao_ID = 3 where Produto_Variacao_Pai_ID Is not null and Produto_Pai_ID = $produtoID");			mpress_query("update produtos_compostos set Produto_Variacao_Pai_ID = $idVariacao where Produto_Variacao_Pai_ID is null and Produto_Pai_ID = $produtoID");			mpress_query("update produtos_variacoes set Situacao_ID = 3 where Produto_Variacao_ID <> $idVariacao and Produto_ID = $produtoID");			mpress_query("update produtos_variacoes set Codigo = '".$_POST['codigo-variacao-composto']."',												Descricao = '".$_POST['descricao-variacao-composto']."',												Imagem_ID = '".$_POST['imagem-variacao-composto']."',												Valor_Venda = '".formataValorBD($_POST['valor-venda-variacao-composto'])."',												Forma_Cobranca_ID = 35												where Produto_Variacao_ID = $idVariacao and Produto_ID = $produtoID");		}		/*SALVAR CATEGORIAS*/		mpress_query("delete from produtos_dados_categorias where Produto_ID = '$produtoID'");		for($i = 0; $i < count($_POST['chkCategoria']); $i++){			$categoriaID = $_POST['chkCategoria'][$i];			mpress_query("insert into produtos_dados_categorias (Produto_ID, Categoria_ID, Situacao_ID) values ('$produtoID','$categoriaID',1)");		}		/* Salvar nas tabelas de preço se não existir*/		mpress_query("	insert into produtos_tabelas_precos_detalhes (Tabela_Preco_ID, Produto_Variacao_ID, Valor_Custo, Valor_Venda, Situacao_ID)					select ptp.Tabela_Preco_ID, Produto_Variacao_ID, 0,0,1					from produtos_dados pd					inner join produtos_variacoes pv on pd.Produto_ID = pv.Produto_ID					inner join produtos_tabelas_precos ptp					where pd.Produto_ID = '$produtoID'					having (select count(*) from produtos_tabelas_precos_detalhes ptpd					where ptpd.Produto_Variacao_ID = pv.Produto_Variacao_ID and Situacao_ID = 1					and ptpd.Tabela_Preco_ID = ptp.Tabela_Preco_ID) = 0");		echo $produtoID;	}	function enviarlixeiraProduto(){		$produtoID = $_GET['produto-id'];		$sql = "Update produtos_dados set Situacao_ID = 3 where Produto_ID = $produtoID";		mpress_query($sql);		echo "<form action='../../produtos/produtos-cadastrados' method='post' name='retorno'></form><script>document.retorno.submit();</script>";	}	function validaCadastraCategoria(){		$cadastra = $_POST['categoria-cadastra'];		echo $cadastra;	}	function carregarVariacoesProduto($produtoID){		global $modulosAtivos, $caminhoSistema;		if (!($modulosAtivos[envios])){			$classeCD = "esconde";		}		$p = 0;		$sql = "Select Produto_Variacao_ID, Descricao, Valor_Custo, Valor_Venda, Valor_Promocao, DATE_FORMAT(Data_Inicio_Promocao,'%d/%m/%Y') as Data_Inicio_Promocao,				DATE_FORMAT(Data_Fim_Promocao,'%d/%m/%Y') as Data_Fim_Promocao,				coalesce(Altura,0) as Altura, coalesce(Largura,0) as Largura,				coalesce(Comprimento,0) as Comprimento, coalesce(Peso,0) as Peso, coalesce(Saldo_Estoque,0) as Saldo_Estoque,				Forma_Cobranca_ID, Percentual_Venda, Codigo, Imagem_ID, Unidade, CEAN				from produtos_variacoes where Produto_ID = '$produtoID' and Situacao_ID = 1 order by Produto_Variacao_ID desc";		//echo $sql;		$query = mpress_query($sql);		$qtdVariacoes = mpress_count($query);		while($varicao = mpress_fetch_array($query)){			$p++;			$formaCobrancaID[$p]	= $varicao[Forma_Cobranca_ID];			$produtoVariacaoID[$p] 		= $varicao[Produto_Variacao_ID];			$descricaoVariacao[$p] 		= $varicao[Descricao];			$valorCusto[$p] 			= number_format($varicao[Valor_Custo], 2, ',', '.');			$valorVenda[$p] 			= number_format($varicao[Valor_Venda], 2, ',', '.');			$valorPromocao[$p] 			= number_format($varicao[Valor_Promocao], 2, ',', '.');			$percentualVenda[$p] 		= number_format($varicao[Percentual_Venda], 2, ',', '.');			$dataInicioPromocao[$p] 	= $varicao[Data_Inicio_Promocao];			if ($dataInicioPromocao[$p]=='00/00/0000'){$dataInicioPromocao[$p]='';}			$dataFimPromocao[$p] 		= $varicao[Data_Fim_Promocao];			if ($dataFimPromocao[$p]=='00/00/0000'){$dataFimPromocao[$p]='';}			$alturaVariacao[$p] 		= number_format($varicao[Altura], 2, ',', '.');			$larguraVariacao[$p] 		= number_format($varicao[Largura], 2, ',', '.');			$comprimentoVariacao[$p] 	= number_format($varicao[Comprimento], 2, ',', '.');			$pesoVariacao[$p] 			= number_format($varicao[Peso], 3, ',', '.');			$saldoEstoqueVariacao[$p] 	= number_format($varicao[Saldo_Estoque], 2, ',', '.');			$codigoVariacao[$p]			= $varicao['Codigo'];			$imgVariacao[$p] 			= $varicao['Imagem_ID'];			$unidadeVariacao[$p]		= $varicao['Unidade'];			$cean[$p]					= $varicao['CEAN'];		}		$i = $p;		echo "<input type='hidden' id='acao-variacao' name='acao-variacao' value=''>";		for ($p = 0; $p <= $i; $p++) {			if ($unidadeVariacao[$p]=="") $unidadeVariacao[$p] = "UN";			if ($p=="0") $escondePrimeiro = "esconde"; else $escondePrimeiro = "";?>			<div id='produto-variacao-<?php echo $p;?>' style='width:99%;border:1px solid #bcc4d3;float:left;padding:7px; margin-bottom:3px;' class='<?php echo $escondePrimeiro;?>'>				<div class='titulo-secundario' style='float:left; width:5%'>					<p>ID</p>					<p><input type="text" id="produto-variacao-id-<?php echo $p;?>" name="produto-variacao-id-<?php echo $p;?>" value='<?php echo $produtoVariacaoID[$p]; ?>' class='formata-campo' style='width:85%' readonly/></p>				</div>				<div class='titulo-secundario div-codigo' style='float:left; width:5%'>					<p>C&oacute;digo</p>					<p><input type="text" id="codigo-variacao-<?php echo $p;?>" name="codigo-variacao-<?php echo $p;?>"  value='<?php echo $codigoVariacao[$p]; ?>' class='formata-campo' style='width:85%' maxlength='250'/></p>				</div>				<div class='titulo-secundario' style='float:left; width:10%'>					<div class='dados-produto'>						<p>C&oacute;digo de Barra</p>						<p><input type="text" id="cean-<?php echo $p;?>" name="cean-<?php echo $p;?>"  value='<?php echo $cean[$p]; ?>' class='formata-campo' style='width:85%' maxlength='250'/></p>					</div>				</div>				<div class='titulo-secundario descricao-variacao' style='float:left; width:30%'>					<p>Descri&ccedil;&atilde;o Varia&ccedil;&atilde;o</p>					<p><input type="text" id="descricao-variacao-<?php echo $p;?>" name="descricao-variacao-<?php echo $p;?>"  value='<?php echo $descricaoVariacao[$p]; ?>' class='formata-campo' style='width:96.5%' maxlength='250'/></p>				</div>				<div class='titulo-secundario' style='float:left; width:10%'>					<div class='dados-produto'>						<p>Unidade</p>						<p><input type="text" id="unidade-<?php echo $p;?>" name="unidade-<?php echo $p;?>"  value='<?php echo $unidadeVariacao[$p]; ?>' class='formata-campo' style='width:85%' maxlength='5'/></p>					</div>				</div>				<div class='titulo-secundario' style='float:left; width:20%'>					<p>Forma de Cobran&ccedil;a</p>					<p style='width:95%'>						<select id='forma-cobranca-<?php echo $p;?>' name='forma-cobranca-<?php echo $p;?>' class='forma-cobranca' indice='<?php echo $p;?>' style='width:95%'><?php echo optionValueGrupo(20, $formaCobrancaID[$p]); ?></select>					</p>				</div>				<div class='titulo-secundario' style='float:left; width:20%'>					<p>Imagem Varia&ccedil;&atilde;o</p>					<p>						<select id='imagem-variacao-<?php echo $p;?>' name='imagem-variacao-<?php echo $p;?>' style='width:95%'>							<option value=''>Sem imagem</option><?php			$rs = mpress_query("select Anexo_ID, Nome_Arquivo from modulos_anexos ma where ma.Situacao_ID = 1 and ma.Chave_Estrangeira = '$produtoID' and Tabela_Estrangeira = 'produtos' order by Nome_Arquivo");			while($row = mpress_fetch_array($rs)){				if($imgVariacao[$p] == $row['Anexo_ID']) $selecionado = "selected"; else $selecionado = "";				echo "				<option value='".$row['Anexo_ID']."' $selecionado>".$row['Nome_Arquivo']."</option>";			}?>						</select>					</p>				</div>				<div class="titulo-secundario cinco-colunas fc fc-36-<?php echo $p;?>">					<p>Percentual de Lucro </p>					<p><input type="text" id="percentual-venda-<?php echo $p;?>" name="percentual-venda-<?php echo $p;?>"  value='<?php echo $percentualVenda[$p]; ?>' class=' formata-valor formata-valor-percentual' maxlength='18'/></p>				</div>				<div class="titulo-secundario cinco-colunas fc fc-35-<?php echo $p;?> fc-58-<?php echo $p;?>">					<p>Pre&ccedil;o Venda <i class='fc fc-58-<?php echo $p;?>'>(Sugestivo)</i></p>					<p><input type="text" id="valor-venda-variacao-<?php echo $p;?>" name="valor-venda-variacao-<?php echo $p;?>"  value='<?php echo $valorVenda[$p]; ?>' class='valor-venda-variacao formata-valor formata-valor-moeda-real' maxlength='18'/></p>				</div>				<div class="titulo-secundario cinco-colunas fc fc-35-<?php echo $p;?> fc-58-<?php echo $p;?>">					<p>Preço						<span class='fc fc-35-<?php echo $p;?>'>Promo&ccedil;&atilde;o</span>						<span class='fc fc-58-<?php echo $p;?>'>M&iacute;nimo Venda</span>					<p><input type="text" id="valor-promocao-variacao-<?php echo $p;?>" name="valor-promocao-variacao-<?php echo $p;?>"  value='<?php echo $valorPromocao[$p]; ?>' class='formata-valor formata-valor-moeda-real' maxlength='18' /></p>				</div>				<div class="titulo-secundario cinco-colunas fc fc-35-<?php echo $p;?>">					<div style='float:left; width:50%;'>						<p>Inicio Promo&ccedil;&atilde;o</p>						<p><input type="text" id="data-inicio-promocao-variacao-<?php echo $p;?>" style='width:85%' name="data-inicio-promocao-variacao-<?php echo $p;?>"  value='<?php echo $dataInicioPromocao[$p]; ?>' class='formata-data' maxlength='10'/></p>					</div>					<div style='float:left; width:50%;'>						<p>Fim Promo&ccedil;&atilde;o</p>						<p><input type="text" id="data-fim-promocao-variacao-<?php echo $p;?>" style='width:85%' name="data-fim-promocao-variacao-<?php echo $p;?>"  value='<?php echo $dataFimPromocao[$p]; ?>' class='formata-data' maxlength='10'/></p>					</div>				</div>				<div class="titulo-secundario cinco-colunas fc fc-35-<?php echo $p;?> fc-58-<?php echo $p;?>">					<p>Pre&ccedil;o Custo <i class='fc fc-58-<?php echo $p;?>'>(Sugestivo)</i></p>					<p>						<input type="text" id="valor-custo-variacao-<?php echo $p;?>" name="valor-custo-variacao-<?php echo $p;?>"  value='<?php echo $valorCusto[$p]; ?>' class='formata-valor formata-valor-moeda-real' maxlength='18'/>					</p>				</div>				<div class="titulo-secundario cinco-colunas fc fc-35-<?php echo $p;?>">					<div style='float:left; margin-top:15px;' title='Tabela(s) de Pre&ccedil;o(s)' class='btn-dinheiro editar-tabelas-precos' produto-variacao-id='<?php echo $produtoVariacaoID[$p]; ?>'>&nbsp;</div>				</div>				<div style='float:left;width:100%'>					<div class="titulo-secundario dados-produto" style='width:20%; float:left;'>						<p>Altura (cm)</p>						<p><input type="text" id="altura-variacao-<?php echo $p;?>" style='width:93%' name="altura-variacao-<?php echo $p;?>"  value='<?php echo $alturaVariacao[$p]; ?>'  class='formata-valor' maxlength='18'/></p>					</div>					<div class="titulo-secundario dados-produto" style='width:20%; float:left;'>						<p>Largura (cm)</p>						<p><input type="text" id="largura-variacao-<?php echo $p;?>" style='width:93%' name="largura-variacao-<?php echo $p;?>"  value='<?php echo $larguraVariacao[$p]; ?>'  class='formata-valor' maxlength='18'/></p>					</div>					<div class="titulo-secundario dados-produto" style='width:20%; float:left;'>						<p>Comprimento (cm)</p>						<p><input type="text" id="comprimento-variacao-<?php echo $p;?>" style='width:93%' name="comprimento-variacao-<?php echo $p;?>"  value='<?php echo $comprimentoVariacao[$p]; ?>'  class='formata-valor' maxlength='18'/></p>					</div>					<div class="titulo-secundario dados-produto" style='width:20%; float:left;'>						<p>Peso (kilos)</p>						<p><input type="text" id="peso-variacao-<?php echo $p;?>" style='width:93%' name="peso-variacao-<?php echo $p;?>"  value='<?php echo $pesoVariacao[$p]; ?>'  class='formata-valor-decimal-3' maxlength='18'/></p>					</div><?php	echo "			<div class='titulo-secundario' style='width:20%; float:right;'>						<p>&nbsp;";	if($qtdVariacoes>1){		echo "				<div style='float:right' class='btn-excluir' attr-id='".$produtoVariacaoID[$p]."' title='excluir varia&ccedil;&atilde;o' id='botao-exclui-produto-variacao'>&nbsp;</div>";	}	echo "				</p>					</div>";?>				</div>			</div><?php 		}			echo " <input type='hidden' id='qtd-variacoes' value='$qtdVariacoes'/><script type='text/javascript' src='$caminhoSistema/javascript/funcoes.formatacao.js'></script>";	}	function enviarEmailJustificativaManual($dadosEmail, $movimentacoesID){			global $dadosUserLogin, $caminhoSistema, $tituloSistema;			foreach($movimentacoesID as $movimentacaoID){				$ids = $virgula.$movimentacaoID;				$virgula = ",";			}			$sql = "select tm.Descr_Tipo as Movimentacao, cd.Descricao as Estoque, pm.Quantidade, CONCAT(pd.Nome, ' ', pv.Descricao) as Produto, Justificativa					from produtos_movimentacoes pm						inner join produtos_variacoes pv on pv.Produto_Variacao_ID = pm.Produto_Variacao_ID						inner join produtos_dados pd on pd.Produto_ID = pv.Produto_ID						inner join envios_centros_distribuicao cd on cd.CD_ID = pm.CD_ID						inner join tipo tm on tm.Tipo_ID = pm.Tipo_Movimentacao_ID					where pm.Produto_Movimentacao_ID in ($ids)";			$conteudoEmail = "					<table border='0' align='center' cellpadding='0' cellspacing='0'>						<tr>							<td>								<table width='735' border='0' align='center' cellpadding='5' cellspacing='0' style='font-family:Helvetica, Arial, Tahoma, Verdana, sans-serif; font-weight: normal; font-size:13px; color:#222222; margin:21px; border:0px;'>									<tr>										<td align='left' valign='top' width='735' colspan='2' style='border-bottom:1px solid #cccccc;'><b><center>Justificativa de Movimenta&ccedil;&atilde;o Manual:</center></b></td>									</tr>									<tr>										<td align='left' valign='top' colspan='2' style='border-bottom:1px solid #cccccc;'><b>Produtos e Materiais:</b></td>									</tr>";			$rs = mpress_query($sql);			while($rs = mpress_fetch_array($rs)){				$quantidade = $rs['Quantidade'];				if ($quantidade<0) $quantidade = $quantidade * -1;				$conteudoEmail .= "	<tr>										<td align='left' valign='top' colspan='2' style='border-bottom:1px solid #cccccc;'>											<p>".utf8_encode($rs['Movimentacao'])." de ".number_format($quantidade, 2, ',', '.')." no CD ".utf8_encode($rs['Estoque'])."</p>											<p align='center'>Justificativa:</p>											<p>".utf8_encode($rs['Justificativa'])."</p>										</td>									</tr>";			}			$conteudoEmail .= "									<tr>										<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'><b>Usu&aacute;rio Respons&aacute;vel:</b></td>										<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'>".utf8_encode($dadosUserLogin['nome'])."</td>									</tr>									<tr>										<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'><b>Data Hora:</b></td>										<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'>".retornaDataHora('','d/m/Y H:i')."</td>									</tr>								</table>							</td>						</tr>					</table>";			$titulo = $tituloSistema." - Entrada Manual de Produtos";			echo enviaEmails($dadosEmail, $titulo, geraEmailPadrao($conteudoEmail), "<p>Envio efetuado com successo</p>");	}	function executarMovimentacao(){		global $dadosUserLogin, $caminhoSistema, $tituloSistema, $configProdutos;		$dataHoraAtual = "'".retornaDataHora('','Y-m-d H:i:s')."'";		$configLaboratorio = carregarConfiguracoesGeraisModulos('laboratorio');		$movimentacoesID = array();		for($i = 0; $i < count($_POST['qtd-movimentacao']); $i++){			$chaveEstrangeiraProdutoID = $produtoVariacaoID = $_POST['produto-variacao-id'][$i];			$quantidadeMov = formataValorBD($_POST['qtd-movimentacao'][$i]);/**/			$tabelaEstrangeira = "produtos";			$chaveEstrangeira = "";			$descricaoParaLaboratorio = " - Manual Produtos";			if ($_POST['tipo-movimentacao']=="compras"){				$tabelaEstrangeira = "compras";				$chaveEstrangeira = $_POST['ordem-compra-id'][$i];				$chaveEstrangeiraProdutoID = $_POST['ordem-compra-finalizada-id'][$i];				$descricaoParaLaboratorio = " - via Compras";				$resutSet = mpress_query("select Fornecedor_ID from compras_ordem_compras_finalizadas									where Ordem_Compra_ID = '$chaveEstrangeira'");				if($rs = mpress_fetch_array($resutSet)){					$origemCadastroID = $rs["Fornecedor_ID"];				}			}			if ($_POST['tipo-movimentacao']=="cd"){				$tabelaEstrangeira = "envios";				$chaveEstrangeira = $_POST['envio-id'][$i];				$chaveEstrangeiraProdutoID = $_POST['envio-produto-id'][$i];				$descricaoParaLaboratorio = " - via Centro de Distribuicao";				$resutSet = mpress_query("select Cadastro_ID_de from envios_workflows where Workflow_ID = '$chaveEstrangeira'");				if($rs = mpress_fetch_array($resutSet)){					$origemCadastroID = $rs["Cadastro_ID_de"];				}			}			$sqlMov = "";			if ($quantidadeMov>0){				$tipoMov = "66";				$quantidadeMovAux = $quantidadeMov;				$quantidadeUnit = 1;				$descricaoParaLaboratorio = "Entrada".$descricaoParaLaboratorio;			}			else {				$tipoMov = "67";				$quantidadeMovAux = $quantidadeMov * (-1);				$quantidadeUnit = -1 ;				//$descricaoParaLaboratorio = "Saída".$descricaoParaLaboratorio;				$descricaoParaLaboratorio = "";			}/**/			if ($quantidadeMov!=0){				if ($_POST['numero-serie'][$chaveEstrangeiraProdutoID]=="1"){					for($ii = 0; $ii < count($_POST['numeros-series'][$chaveEstrangeiraProdutoID]); $ii++){						$numeroSerie = $_POST['numeros-series'][$chaveEstrangeiraProdutoID][$ii];						$enviarPara = $_POST['enviar-material-para'][$chaveEstrangeiraProdutoID][$ii];						$notaFiscal = $_POST['nota-fiscal'][$chaveEstrangeiraProdutoID];						$justificativa = $_POST['justificativa'][$chaveEstrangeiraProdutoID];						$sqlMov = "insert into produtos_movimentacoes (Numero_Serie, CD_ID, Chave_Estrangeira, Chave_Estrangeira_Produto, Tabela_Estrangeira, Produto_Variacao_ID, Tipo_Movimentacao_ID, Quantidade, Nota_Fiscal, Justificativa, Data_Cadastro, Usuario_Cadastro_ID)														values ('$numeroSerie', '$enviarPara', '$chaveEstrangeira', '$chaveEstrangeiraProdutoID', '$tabelaEstrangeira','".$produtoVariacaoID."','".$tipoMov."','".$quantidadeUnit."','".$notaFiscal."', '".$justificativa."', $dataHoraAtual, '".$dadosUserLogin['userID']."')";						$query = mpress_query($sqlMov);						$movimentacaoID = mpress_identity();						$movimentacoesID[] = $movimentacaoID;						// CASO ENVIADO PARA LABORATÓRIO						if ($enviarPara < 0){							mpress_query("UPDATE produtos_movimentacoes set Situacao_ID = 3 where Produto_Movimentacao_ID = '$movimentacaoID'");							mpress_query("INSERT INTO laboratorio_produtos (Produto_Movimentacao_ID, Produto_Variacao_ID, Origem_Cadastro_ID, Status_ID, Tecnico_Responsavel_ID, Descricao, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)																	VALUES 	('$movimentacaoID', '$produtoVariacaoID', '$origemCadastroID', 131,   0, '$descricaoParaLaboratorio', $dataHoraAtual, '".$dadosUserLogin['userID']."', 1)");							$laboratorioProdutoID = mpress_identity();							mpress_query("INSERT INTO laboratorio_produtos_follows (Laboratorio_Produto_ID, Status_ID, Descricao, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)																			VALUES ('$laboratorioProdutoID', 131, '$descricaoParaLaboratorio', $dataHoraAtual, '".$dadosUserLogin['userID']."', 1)");							if($configLaboratorio['email-entrada']!=''){								$rs = mpress_query("select concat(coalesce(pd.Nome,''),' ',coalesce(pv.Descricao,'')) as Produto												from produtos_dados pd												inner join produtos_variacoes pv on pv.Produto_ID = pd.Produto_ID												where pv.Produto_Variacao_ID = '$produtoVariacaoID'");								if($row = mpress_fetch_array($rs)){									enviarEmailLaboratorio($configLaboratorio['email-entrada'], $laboratorioProdutoID, 'Entrada e material para an&aacute;lise', $row['Produto'], $dadosUserLogin['nome'], retornaDataHora('','d/m/Y H:i'));								}							}						}					}				}				else{					// CASO ENVIADO PARA LABORATÓRIO					$enviarPara = $_POST['enviar-material-para'][$chaveEstrangeiraProdutoID];					$notaFiscal = $_POST['nota-fiscal'][$chaveEstrangeiraProdutoID];					$justificativa = $_POST['justificativa'][$chaveEstrangeiraProdutoID];					if ($enviarPara < 0){						for ($i = 1; $i <= $quantidadeMov; $i++) {							$sqlMov = "insert into produtos_movimentacoes (Chave_Estrangeira, CD_ID, Chave_Estrangeira_Produto, Tabela_Estrangeira, Produto_Variacao_ID, Tipo_Movimentacao_ID, Quantidade, Nota_Fiscal, Justificativa, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)																values ('$chaveEstrangeira', '$enviarPara', '$chaveEstrangeiraProdutoID', '$tabelaEstrangeira','".$produtoVariacaoID."','$tipoMov','1','".$notaFiscal."', '".$justificativa."', '$dataHoraAtual, '".$dadosUserLogin['userID']."', 3)";							mpress_query($sqlMov);							$movimentacaoID = mpress_identity();							$movimentacoesID[] = $movimentacaoID;							mpress_query("INSERT INTO laboratorio_produtos (Produto_Movimentacao_ID, Produto_Variacao_ID, Origem_Cadastro_ID, Status_ID, Tecnico_Responsavel_ID, Descricao, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)																	VALUES 	('$movimentacaoID', '$produtoVariacaoID', '$origemCadastroID', 131,   0, '$descricaoParaLaboratorio', $dataHoraAtual, '".$dadosUserLogin['userID']."', 1)");							$laboratorioProdutoID = mpress_identity();							mpress_query("INSERT INTO laboratorio_produtos_follows (Laboratorio_Produto_ID, Status_ID, Descricao, Data_Cadastro, Usuario_Cadastro_ID, Situacao_ID)																			VALUES ('$laboratorioProdutoID', 131, '$descricaoParaLaboratorio', $dataHoraAtual, '".$dadosUserLogin['userID']."', 1)");							if($configLaboratorio['email-entrada']!=''){								$rs = mpress_query("select concat(coalesce(pd.Nome,''),' ',coalesce(pv.Descricao,'')) as Produto												from produtos_dados pd												inner join produtos_variacoes pv on pv.Produto_ID = pd.Produto_ID												where pv.Produto_Variacao_ID = '$produtoVariacaoID'");								if($row = mpress_fetch_array($rs)){									enviarEmailLaboratorio($configLaboratorio['email-entrada'], $laboratorioProdutoID, 'Entrada e material para an&aacute;lise', $row['Produto'], $dadosUserLogin['nome'], retornaDataHora('','d/m/Y H:i'));								}							}						}					}					else{						$enviarPara = $_POST['enviar-material-para'][$chaveEstrangeiraProdutoID];						$sqlMov = "insert into produtos_movimentacoes (Chave_Estrangeira, CD_ID, Chave_Estrangeira_Produto, Tabela_Estrangeira, 			Produto_Variacao_ID, Tipo_Movimentacao_ID, Quantidade, Nota_Fiscal, Justificativa, Data_Cadastro, Usuario_Cadastro_ID)															values ('$chaveEstrangeira', '$enviarPara', '$chaveEstrangeiraProdutoID', '$tabelaEstrangeira', '".$produtoVariacaoID."', '".$tipoMov."', '".$quantidadeMov."','".$notaFiscal."', '".$justificativa."', $dataHoraAtual, '".$dadosUserLogin['userID']."')";						mpress_query($sqlMov);						$movimentacaoID = mpress_identity();						$movimentacoesID[] = $movimentacaoID;					}				}				if ($_POST['tipo-movimentacao']=="compras"){					$query = mpress_query("update compras_ordem_compras_finalizadas set Quantidade_Entregue = (Quantidade_Entregue + ".$quantidadeMovAux.") where Ordem_Compra_Finalizada_ID = '$chaveEstrangeiraProdutoID'");				}				if ($_POST['tipo-movimentacao']=="cd"){					$sql = "update envios_workflows_produtos set Quantidade_Entregue = (Quantidade_Entregue + ".$quantidadeMovAux.") where Workflow_Produto_ID = '$chaveEstrangeiraProdutoID'";					$query = mpress_query($sql);				}			}		}		if ($_POST['tipo-movimentacao']=="manual"){			if($configProdutos['emails-justificativa-manual']!=''){				enviarEmailJustificativaManual($configProdutos['emails-justificativa-manual'], $movimentacoesID);			}		}	}	function enviarEmailLaboratorio($dadosEmail, $laboratorioID, $descrSituacao, $produto, $nome, $dataHoraEntrada){		global $dadosUserLogin, $caminhoSistema, $tituloSistema;		$conteudoEmail = "				<table border='0' align='center' cellpadding='0' cellspacing='0'>					<tr>						<td>							<table width='735' border='0' align='center' cellpadding='5' cellspacing='0' style='font-family:Helvetica, Arial, Tahoma, Verdana, sans-serif; font-weight: normal; font-size:13px; color:#222222; margin:21px; border:0px;'>								<tr>									<td align='left' valign='top' width='160' style='border-bottom:1px solid #cccccc;'><b>Ordem Laboratório:</b></td>									<td align='left' valign='top' width='575' style='border-bottom:1px solid #cccccc;'>$laboratorioID</td>								</tr>								<tr>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'><b>Situa&ccedil;&atilde;o:</b></td>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'>$descrSituacao</td>								</tr>								<tr>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'><b>Material para an&aacute;lise:</b></td>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'>$produto</td>								</tr>								<tr>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'><b>Usu&aacute;rio:</b></td>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'>$nome</td>								</tr>								<tr>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'><b>Data Entrada:</b></td>									<td align='left' valign='top' style='border-bottom:1px solid #cccccc;'>$dataHoraEntrada</td>								</tr>							</table>						</td>					</tr>				</table>";		$titulo = $tituloSistema." - Entrada Laboratório: ".$laboratorioID;		echo enviaEmails($dadosEmail, $titulo, geraEmailPadrao($conteudoEmail), "<p>Envio efetuado com successo</p>");	}	function carregarMovimentacoes($produtoVariacaoID){		global $modulosAtivos, $modulosGeral, $caminhoSistema;		if ($modulosGeral['laboratorio']=="1"){			$sqlLeft = " 	left join laboratorio_produtos lp on lp.Produto_Movimentacao_ID = m.Produto_Movimentacao_ID					  		left join tipo tlp on tlp.Tipo_ID = lp.Status_ID ";			$sqlCampos = ", tlp.Descr_Tipo as Status_Produto ";		}		$sql = "select Chave_Estrangeira, t.Descr_Tipo, Quantidade, m.Data_Cadastro, coalesce(mo.Nome,'N/A') as Modulo, u.Nome as Nome_Usuario,								Tabela_Estrangeira, concat(coalesce(pd.Nome,''),' ',coalesce(pv.Descricao,'')) as Nome, pv.codigo, pv.Produto_Variacao_ID,								m.Numero_Serie as Numero_Serie, m.Situacao_ID as Situacao_ID, pd.Numero_Serie as Utiliza_NS,								ecd.Descricao as Estoque, m.Nota_Fiscal as Nota_Fiscal, m.Justificativa										$sqlCampos										from produtos_variacoes pv										inner join produtos_dados pd on pd.Produto_ID = pv.Produto_ID										inner join produtos_movimentacoes m on pv.Produto_Variacao_ID = m.Produto_Variacao_ID										left join envios_centros_distribuicao ecd on ecd.CD_ID = m.CD_ID										left join tipo t on t.Tipo_ID = m.Tipo_Movimentacao_ID										left join cadastros_dados u on u.Cadastro_ID = m.Usuario_Cadastro_ID										left join modulos mo on mo.slug = m.Tabela_Estrangeira										$sqlLeft										where pv.Produto_Variacao_ID = '$produtoVariacaoID'										and m.Situacao_ID in (1,2,3)										order by m.Data_Cadastro desc";		$resultado = mpress_query($sql);		while($row = mpress_fetch_array($resultado)){			$i++;			if ($row['Chave_Estrangeira']!=0) $complemento = " - ".$row['Chave_Estrangeira']; else $complemento = " - Entrada Manual";			if (($modulosGeral['laboratorio']=="1") && ($row['Utiliza_NS']=="1") && ($row['Status_Produto']!="")) {				$complemento .= " Laboratório *** ".$row['Status_Produto'];			}			if($row['Quantidade'] <= 0) $row['Quantidade'] *= -1;			if($row['Descr_Tipo']=='Saida') $corFonte="Style='color:#ab4c4c'"; else $corFonte="Style='color:#005ba2'";			$dados[colunas][conteudo][$i][1] = "<center $corFonte>".converteData($row['Data_Cadastro'],1)."</center>";			$dados[colunas][conteudo][$i][2] = "<center $corFonte>".$row['Descr_Tipo']."</center>";			$dados[colunas][conteudo][$i][3] = "<center $corFonte>".number_format($row['Quantidade'], 2, ',', '.')."</center>";			$dados[colunas][conteudo][$i][4] = "<span $corFonte>&nbsp;".$row['Modulo'].$complemento."</span>";			$dados[colunas][conteudo][$i][5] = "<span $corFonte>&nbsp;".$row['Estoque']."</span>";			$dados[colunas][conteudo][$i][6] = "<span $corFonte>&nbsp;".$row['Nota_Fiscal']."</span>";			$dados[colunas][conteudo][$i][7] = "<span $corFonte>&nbsp;".$row['Numero_Serie']."</span>";			$dados[colunas][conteudo][$i][8] = "<span $corFonte>&nbsp;".$row['Justificativa']."</span>";			$dados[colunas][conteudo][$i][9] = "<span $corFonte>&nbsp;".$row['Nome_Usuario']."</span>";		}		$dados[colunas][tamanho][1] = "width='130px'";		$dados[colunas][tamanho][2] = "width='140px'";		$dados[colunas][tamanho][3] = "width='100px'";		$dados[colunas][tamanho][4] = "";		$dados[colunas][tamanho][5] = "";		$dados[colunas][tamanho][9] = "width='250px'";		$dados[colunas][titulo][1] 	= "<center>Data Movimenta&ccedil;&atilde;o</center>";		$dados[colunas][titulo][2] 	= "<center>Tipo Movimenta&ccedil;&atilde;o</center>";		$dados[colunas][titulo][3] 	= "<center>Quantidade</center>";		$dados[colunas][titulo][4] 	= "M&oacute;dulo";		$dados[colunas][titulo][5] 	= "CD - Estoque";		$dados[colunas][titulo][6] 	= "Nota Fiscal";		$dados[colunas][titulo][7] 	= "N&uacute;mero de S&eacute;rie";		$dados[colunas][titulo][8] 	= "Justificativa";		$dados[colunas][titulo][9] 	= "Usu&aacute;rio";		echo "<div style='float:right; width:100%; margin-top:10px; margin-bottom:10px;'>";		if ($i==0){			$dados[colunas][colspan][$i+1][1] = 7;			$dados[colunas][conteudo][$i+1][1] = "<p style='margin:0px; color:red;' align='center'>Nenhuma movimenta&ccedil;&atilde;o realizada</p>";		}		geraTabela("100%", 9, $dados, "tabela-estoque-".$produtoVariacaoID,'',2,2,20);		echo "</div>";	}	function carregarMovimentacaoNumerosSerie(){		global $modulosGeral;		$chaveEstrangeiraProdutoID = $_GET['chave-estrangeira'];		$valorBaixa = formataValorBD($_GET['valor-baixa']);		$valorBaixaAux = formataValorBD($_GET['valor-baixa']);		$produtoVariacaoID = $_GET['produto-variacao-id'];		$numeroSerie = $_GET['numero-serie'];		$tipoEntrada = $_POST['tipo-entrada'];		// SE VEIO DO COMPRAS VAI DIRETO PARA ESTOQUE NÃO DEIXA COLOCAR EM LABORATÓRIO		if (($tipoEntrada=='compras')||($valorBaixaAux < 0)){			$sqlCond = " and CD_ID > 0 ";		}		$classeSelecionaEstoqueSerie = "";		if ($valorBaixaAux<0){			$optionValueNumerosSeriais = "";			$valorBaixa = ($valorBaixa * (-1));			$descrMov = "SAÍDA";			$descrDestinoRetirada = "Retirada de";			$optionValueNumerosSeriais = "<option value=''></option>";			$resultado = mpress_query("select SUM(Quantidade) AS Quantidade, Numero_Serie, CD_ID from produtos_movimentacoes where Produto_Variacao_ID = '$produtoVariacaoID' and Numero_Serie <> ''  and Situacao_ID = 1 GROUP BY Numero_Serie, CD_ID having SUM(Quantidade) > 0");			while($rs = mpress_fetch_array($resultado)){				$optionValueNumerosSeriais .= "<option value='".$rs['Numero_Serie']."' cd-id='".$rs['CD_ID']."'>".$rs['Numero_Serie']."</option>";			}			if ($numeroSerie=="S"){				$classeSelecionaEstoqueSerie = "sel-estoque-serie";			}		}		else{			$descrMov = "ENTRADA";			$descrDestinoRetirada = "Destino";		}		$resultado = mpress_query("SELECT CD_ID, Descricao FROM envios_centros_distribuicao where Situacao_ID = 1 ".$sqlCond);		while($rs = mpress_fetch_array($resultado))			$optionValueEstoques .= "<option value='".$rs['CD_ID']."'>".$rs['Descricao']."</option>";		echo "<div class='titulo-secundario' style='float:right; width:300px'>				<div class='titulo-secundario' style='float:right; width:300px'>					<p align='center' style='margin:4px;'><b>EXECUTAR $descrMov</b></p>				</div>";		if ($numeroSerie=="S"){			echo "	<div class='titulo-secundario' style='float:right; width:100px'>						<p><b>$descrDestinoRetirada:</b></p>					</div>";			echo "	<div class='titulo-secundario' style='float:right; width:200px'>						<p><b>Informe o(s) n&uacute;mero(s) de s&eacute;rie:</b></p>					</div>";			for ($i=1; $valorBaixa >= $i; $i++) {				echo "	<div class='titulo-secundario' style='float:right; width:100px'>							<p>								<select id='enviar-material-para-$chaveEstrangeiraProdutoID-$i' name='enviar-material-para[$chaveEstrangeiraProdutoID][]' class='required select-enviar-material' style='width:100px'>									<option value=''></option>									$optionValueEstoques								</select>							</p>						</div>";				echo "	<div class='titulo-secundario' style='float:right; width:200px'>							<p>";				if ($valorBaixaAux<0)					echo "		<select 			id='numeros-series-$chaveEstrangeiraProdutoID-$i' name='numeros-series[$chaveEstrangeiraProdutoID][]' class='required valida-numero-serial ".$classeSelecionaEstoqueSerie."' chave-estrangeira-id='".$chaveEstrangeiraProdutoID."' posicao='".$i."' ns-anterior='' style='width:180px'>$optionValueNumerosSeriais</select>";				else					echo "		<input type='text' id='numeros-series-$chaveEstrangeiraProdutoID-$i' name='numeros-series[$chaveEstrangeiraProdutoID][]' class='required valida-serial-duplicado' produto-variacao-id='$produtoVariacaoID' style='width:180px' value=''/>";				echo "		</p>						</div>";			}		}		else{			echo "	<div class='titulo-secundario' style='float:right; width:400px'>						<p><b>$descrDestinoRetirada:</b></p>					</div>";			echo " <div class='titulo-secundario' style='float:right; width:400px'>						<select id='enviar-material-para' name='enviar-material-para[$chaveEstrangeiraProdutoID]' class='required select-enviar-material' style='width:390px'>							<option value=''></option>							".$optionValueEstoques."						</select>					</div>";		}		echo "	<div class='titulo-secundario' style='float:right; width:400px'>					<br>					<p align='left' style='margin:4px;'><b>Informe a Nota Fiscal:</b></p>					<input type='text' name='nota-fiscal[".$chaveEstrangeiraProdutoID."]' id='nota-fiscal-$chaveEstrangeiraProdutoID' class='' style='width:98%' value=''/>				</div>";		if ($_POST['tipo-movimentacao']=="manual"){			echo "	<div class='titulo-secundario' style='float:right; width:400px'>						<br>						<p align='left' style='margin:4px;'><b>Justificativa para a entrada manual:</b></p>						<textarea type='text' name='justificativa[".$chaveEstrangeiraProdutoID."]' id='justificativa-$chaveEstrangeiraProdutoID' class='required' style='width:98%;height:60px'/></textarea>					</div>";		}		echo "</div>";		echo "<script>$('select').chosen({width: '99%', no_results_text: 'Nenhum registro encontrado!', placeholder_text_single: ' ', placeholder_text_multiple: ' ', allow_single_deselect: true });</script>";	}	function carregarLocalizarProdutos(){		global $caminhoSistema;		$quantidade = 1;		$valorVendaTotal = "0,00";		$valorCustoTotal = "0,00";		$sql = "SELECT pv.Produto_Variacao_ID AS Produto_Variacao_ID, pv.Codigo AS Codigo_Variacao, pd.Codigo AS Codigo, CONCAT(COALESCE(pd.Nome,''),' ', COALESCE(pv.Descricao,'')) AS Descricao_Produto,					pv.Forma_Cobranca_ID, f.Descr_Tipo as Forma_Cobranca, case pv.Forma_Cobranca_ID when 35 then pv.Valor_Venda else '0' end as Valor_Venda					FROM produtos_dados pd					INNER JOIN produtos_variacoes pv ON pd.Produto_ID = pv.Produto_ID					inner join tipo f on f.Tipo_ID = pv.Forma_Cobranca_ID					WHERE pd.Situacao_ID = 1 AND pv.Situacao_ID = 1 AND pd.Produto_ID > 0 AND pv.Produto_Variacao_ID > 0				ORDER BY trim(Descricao_Produto)";		$selectProdutos = "<select id='select-produtos' name='select-produtos' Style='width:100%' data-placeholder='Selecione'>								<option value=''>Selecione</option>";		$resultado = mpress_query($sql);		while($row = mpress_fetch_array($resultado)){			if($row['Codigo_Variacao'] != "") $codigo = $row['Codigo_Variacao']." - "; else $codigo = '';			if ($row['Valor_Venda']!="") $valorVenda = "R$&nbsp;".number_format($row['Valor_Venda'], 2, ',', '.'); else $valorVenda = "";			if ($row['Produto_Variacao_ID']==$produtoVariacaoID) $selecionado = "selected"; else $selecionado = "";			$selectProdutos .= "<option value='".$row[Produto_Variacao_ID]."' $selecionado>$codigo$row[Descricao_Produto]</option>";		}		$selectProdutos .= "			</select>";		echo "	<div id='div-produtos-select' style='float:left; width:82%;'>					<p>Selecione o Produto / Servi&ccedil;o</p>					<p>$selectProdutos</p>				</div>				<div style='width:10%;float:left;'>					<p>Quantidade</p>					<p><input type='text' id='quantidade-produtos' name='quantidade-produtos' value='$quantidade' class='formata-numero' style='width:90%' maxlength='10'/></p>				</div>				<div id='div-produtos-incluir'  style='width:8%; float:left;'>					<p>&nbsp;</p>					<p><input type='button' id='botao-incluir-produto' name='botao-incluir-produto' class='botao-incluir-produto' Style='width:95%' value='Incluir'/></p>				</div>				<script type='text/javascript' src='$caminhoSistema/javascript/funcoes.formatacao.js'></script>";	}	function carregaDetalhesProdutoComposto(){		$p=0;		global $dadosUserLogin;		if ($_POST['produto-id']=="") $produtoID = $dadosUserLogin['userID'] * (-1); else $produtoID = $_POST['produto-id'];		$rs = mpress_query("select pc.Produto_Composto_ID,concat(pd.Nome,' ',pv.Descricao) Nome, pc.Quantidade							from produtos_dados pd							INNER JOIN produtos_variacoes pv ON pv.Produto_ID = pd.Produto_ID							inner join produtos_compostos pc on pc.Produto_Variacao_ID = pv.Produto_Variacao_ID							WHERE pc.Situacao_ID = 1 AND pc.Produto_Pai_ID = $produtoID							order by trim(pd.Nome)");		while($row = mpress_fetch_array($rs)){			$p++;			$dados[colunas][conteudo][$p][1] = $row['Nome'];			$dados[colunas][conteudo][$p][2] = "<center $corFonte>".$row['Quantidade']."</center>";			$dados[colunas][conteudo][$p][3] = "<center $corFonte><a class='link exclui-item-composicao' composicao-id='$row[Produto_Composto_ID]'>X</center>";		}		echo "	<input type='hidden' name='total-composicao' id='total-composicao' value='$p'>				<input type='hidden' name='composicao-id' id='composicao-id' value=''>";		if($p>0){			$dados[colunas][tamanho][1] = "";			$dados[colunas][tamanho][2] = "width='140px'";			$dados[colunas][tamanho][3] = "width='30px'";			$dados[colunas][titulo][1] 	= "Produto";			$dados[colunas][titulo][2] 	= "<center>Quantidade</center>";			geraTabela("100%", 3, $dados, 'tabela-composicao-produto-composto','',2,2,20);		}	}	function carregarTabelaPrecosFaixas($produtoVariacaoID, $tipoFaixa){		global $dadosUserLogin;		$sql = "SELECT Tabelas_Precos_Faixa_ID, Descricao_Faixa, Tipo_Faixa, tf.Descr_Tipo as Faixa, Tipo_Cobranca, tc.Descr_Tipo as Cobranca,								Produto_Variacao_ID, Caracteristica_ID, Quantidade_Inicial, Quantidade_Final, Valor_Custo, Valor_Venda							FROM produtos_tabelas_precos_faixas pf							inner join tipo tf on tf.Tipo_ID = pf.Tipo_Faixa							left join tipo tc on tc.Tipo_ID = pf.Tipo_Cobranca							where pf.Situacao_ID = 1 and Tipo_Faixa = '$tipoFaixa' and Produto_Variacao_ID = '$produtoVariacaoID'							Order by pf.Quantidade_Inicial";		//echo "------>".$sql;		$rs = mpress_query($sql);		while($row = mpress_fetch_array($rs)){			$p++;			$c=1;			$dados[colunas][conteudo][$p][$c++] = $row['Descricao_Faixa'];			$dados[colunas][conteudo][$p][$c++] = "<p align='right'>".number_format($row['Quantidade_Inicial'], 2, ',', '.')."</p>";			$dados[colunas][conteudo][$p][$c++] = "<p align='right'>".number_format($row['Quantidade_Final'], 2, ',', '.')."</p>";			$dados[colunas][conteudo][$p][$c++] = "<p align='center'>".$row['Cobranca']."</p>";			$dados[colunas][conteudo][$p][$c++] = "<p align='right'>".number_format($row['Valor_Venda'], 2, ',', '.')."</p>";			$dados[colunas][conteudo][$p][$c++] = "<div style='float:right' class='btn-excluir btn-excluir-faixa-preco botoes-acoes' attr-id='".$row['Tabelas_Precos_Faixa_ID']."' tipo-faixa='$tipoFaixa' title='Excluir faixa tabela'>&nbsp;</div>												   <div style='float:right' class='btn-editar btn-editar-faixa-preco botoes-acoes' attr-id='".$row['Tabelas_Precos_Faixa_ID']."' tipo-faixa='$tipoFaixa' title='Editar faixa tabela'>&nbsp;</div>";		}		if($p>0){			$c = 1;			$dados[colunas][tamanho][$c++] = "";			$dados[colunas][tamanho][$c++] = "width='10%'";			$dados[colunas][tamanho][$c++] = "width='10%'";			$dados[colunas][tamanho][$c++] = "width='15%'";			$dados[colunas][tamanho][$c++] = "width='15%'";			$dados[colunas][tamanho][$c++] = "width='40px'";			$c = 1;			$dados[colunas][titulo][$c++] 	= "Descri&ccedil;&atilde;o";			$dados[colunas][titulo][$c++] 	= "<p align='right'>Quantidade Inicial</p>";			$dados[colunas][titulo][$c++] 	= "<p align='right'>Quantidade Final</p>";			$dados[colunas][titulo][$c++] 	= "<p align='center'>Tipo Cobran&ccedil;a</p>";			$dados[colunas][titulo][$c++] 	= "<p align='right'>Valor Cobran&ccedil;a</p>";			$c++;			geraTabela("100%", ($c-1), $dados, '','',2,2);		}		else{			echo "<p align='center'>Nenhuma faixa cadastrada</p>";		}	}	function incluirEditarPrecosFaixas(){		global $dadosUserLogin, $caminhoSistema;		$tipoFaixa = $_GET['tipo-faixa'];		$id = $_GET['id'];		$quantiadeInicial = "0,00";		$quantiadeFinal = "0,00";		$valorVenda = "0,00";		$produtoVariacaoID = $_POST['produto-variacao-id'];		$nomeBotao = "Incluir";		if ($id!=""){			$sql = "	SELECT Descricao_Faixa, Tipo_Faixa, Tipo_Cobranca, Caracteristica_ID, Quantidade_Inicial, Quantidade_Final, Valor_Custo, Valor_Venda, Situacao_ID						FROM produtos_tabelas_precos_faixas where Tabelas_Precos_Faixa_ID = '$id'";			$resultado = mpress_query($sql);			if($rs = mpress_fetch_array($resultado)){				$descricaoFaixa = $rs['Descricao_Faixa'];				$tipoFaixa = $rs['Tipo_Faixa'];				$tipoCobrancaFaixa = $rs['Tipo_Cobranca'];				$caracteristicaID = $rs['Caracteristica_ID'];				$quantiadeInicial = number_format($rs['Quantidade_Inicial'], 2, ',', '.');				$quantiadeFinal = number_format($rs['Quantidade_Final'], 2, ',', '.');				$valorVenda = number_format($rs['Valor_Venda'], 2, ',', '.');				$nomeBotao = "Atualizar";			}		}		else{			$sql = "SELECT MAX(Quantidade_Final) as Quantidade_Final FROM produtos_tabelas_precos_faixas pf							where pf.Situacao_ID = 1 and Tipo_Faixa = '$tipoFaixa' and Produto_Variacao_ID = '$produtoVariacaoID'								Order by pf.Quantidade_Inicial";			$resultado = mpress_query($sql);			if($rs = mpress_fetch_array($resultado)){				$quantiadeInicial = number_format($rs['Quantidade_Final'], 2, ',', '.');			}		}		echo "	<input type='hidden' id='tabelas-precos-faixa-id' name='tabelas-precos-faixa-id' value='$id'/>				<input type='hidden' id='tipo-faixa' name='tipo-faixa' value='$tipoFaixa'/><!-- determina se é por 143 - quantidade ou por 144 - caracteristica-->				<div style='float:left; width:30%'>					<p>Descri&ccedil;&atilde;o</p>					<p><input type='text' id='descricao-faixa' name='descricao-faixa' class='required' style='width:98%' value='$descricaoFaixa'/></p>				</div>";		if ($tipoFaixa=="144"){			echo "	<div style='float:left; width:15%'>						<p>Caracter&iacute;stica</p>						<p><select id='caracteristica-id' name='caracteristica-id' class='required'>".utf8_encode(optionValueGrupo(64, $caracteristicaID, "Selecione", ""))."</select></p>					</div>";		}		echo "	<div style='float:left; width:12.5%'>					<p>Quantidade Inicial (de)</p>					<p><input type='text' id='quantidade-faixa-inicial' name='quantidade-faixa-inicial' style='width:95%' class='formata-valor required' value='$quantiadeInicial'/></p>				</div>				<div style='float:left; width:12.5%'>					<p>Quantidade Final (at&eacute;)</p>					<p><input type='text' id='quantidade-faixa-final' name='quantidade-faixa-final' style='width:95%' class='formata-valor required' value='$quantiadeFinal'/></p>				</div>";		if ($tipoFaixa=="143"){			echo "	<div style='float:left; width:15%'>						<p>Cobran&ccedil;a</p>						<p><select id='tipo-cobranca-faixa' name='tipo-cobranca-faixa' class='required'>".utf8_encode(optionValueGrupo(63, $tipoCobrancaFaixa, "Selecione", ""))."</select></p>					</div>";		}		echo "	<div style='float:left; width:10%'>					<p>R$ Valor <span id='tipo-valor'></span></p>					<p><input type='text' id='valor-cobranca-faixa' name='valor-cobranca-faixa' style='width:92%' class='formata-valor required' value='$valorVenda'/></p>				</div>				<div style='float:left; width:10%'>					<p>&nbsp;</p>					<p><input type='button' value='Cancelar' class='cancelar-incluir-faixa'/></p>				</div>				<div style='float:left; width:10%'>					<p>&nbsp;</p>					<p><input type='button' value='$nomeBotao' class='salvar-faixa' id='salvar-faixa'/></p>				</div>				<script type='text/javascript' src='$caminhoSistema/javascript/funcoes.formatacao.js'></script>";	}	function salvarTabelaPrecoVariacaoFaixa(){		global $dadosUserLogin, $caminhoSistema;		$produtoVariacaoID = $_POST['produto-variacao-id'];		if(($_GET['acao']=='D')&&($_GET['id']!='')){			mpress_query("update produtos_tabelas_precos_faixas set Situacao_ID = 3 where Tabelas_Precos_Faixa_ID = '".$_GET['id']."'");		}		else{			$tabelasPrecosFaixaID = $_POST['tabelas-precos-faixa-id'];			$tipoFaixaID = $_POST['tipo-faixa'];			$tipoCobranca = $_POST['tipo-cobranca-faixa'];			$caracteristicaID = $_POST['caracteristica-id'];			$descricaoFaixa = $_POST['descricao-faixa'];			$quantidadeInicial = formataValorBD($_POST['quantidade-faixa-inicial']);			$quantidadeFinal = formataValorBD($_POST['quantidade-faixa-final']);			$valorVendaFaixa = formataValorBD($_POST['valor-cobranca-faixa']);			if ($tabelasPrecosFaixaID==""){				mpress_query("insert into produtos_tabelas_precos_faixas (Descricao_Faixa, Tipo_Faixa, Tipo_Cobranca, Produto_Variacao_ID, Caracteristica_ID, Quantidade_Inicial, Quantidade_Final, Valor_Custo, Valor_Venda, Situacao_ID)											values  ('$descricaoFaixa', '$tipoFaixaID', '$tipoCobranca', '$produtoVariacaoID', '$caracteristicaID', '$quantidadeInicial', '$quantidadeFinal', 0, '$valorVendaFaixa', 1)");			}			else{				mpress_query("update produtos_tabelas_precos_faixas set												Descricao_Faixa = '$descricaoFaixa',												Tipo_Cobranca = '$tipoCobranca',												Caracteristica_ID = '$caracteristicaID',												Quantidade_Inicial = '$quantidadeInicial',												Quantidade_Final = '$quantidadeFinal',												Valor_Venda = $valorVendaFaixa									where Tabelas_Precos_Faixa_ID = '$tabelasPrecosFaixaID'");			}		}		echo "<form action='$caminhoSistema/modulos/produtos/produtos-tabela-preco-variacao.php?produto-variacao-id=$produtoVariacaoID' method='post' name='retorno'></form><script>document.retorno.submit();</script>";	}	function salvarTabelaPrecoVariacao(){		global $dadosUserLogin, $caminhoSistema;		$produtoVariacaoID = $_POST['produto-variacao-id'];		$i=0;		foreach($_POST['tabela-preco-id'] as $tabelaPrecoID){			$valorCusto = formataValorBD($_POST['valor-custo'][$i]);			$valorVenda = formataValorBD($_POST['valor-venda'][$i]);			mpress_query("update produtos_tabelas_precos_detalhes set Situacao_ID = 2 where Tabela_Preco_ID = '$tabelaPrecoID' and Produto_Variacao_ID = '$produtoVariacaoID' and Situacao_ID = 1");			mpress_query("insert into produtos_tabelas_precos_detalhes (Tabela_Preco_ID, Produto_Variacao_ID, Valor_Custo, Valor_Venda)												values  ('$tabelaPrecoID', '$produtoVariacaoID', '$valorCusto', '$valorVenda')");			$i++;		}		echo "<form action='$caminhoSistema/modulos/produtos/produtos-tabela-preco-variacao.php?produto-variacao-id=$produtoVariacaoID' method='post' name='retorno'></form><script>document.retorno.submit();</script>";	}	function salvarTabelaPrecoVariacaoSimples(){		global $dadosUserLogin, $caminhoSistema;		$produtoVariacaoID = $_GET['produtoVariacaoID'];		$tabelaPrecoID = $_GET['tabelaPrecoID'];		$valorCusto = formataValorBD($_GET['valorCusto']);		$valorVenda = formataValorBD($_GET['valorVenda']);		mpress_query("update produtos_tabelas_precos_detalhes set Situacao_ID = 2 where Tabela_Preco_ID = '$tabelaPrecoID' and Produto_Variacao_ID = '$produtoVariacaoID' and Situacao_ID = 1");		mpress_query("insert into produtos_tabelas_precos_detalhes (Tabela_Preco_ID, Produto_Variacao_ID, Valor_Custo, Valor_Venda)											values  ('$tabelaPrecoID', '$produtoVariacaoID', '$valorCusto', '$valorVenda')");	}