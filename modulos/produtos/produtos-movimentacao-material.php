<?php	include("functions.php");	global $modulosAtivos, $modulosGeral, $caminhoSistema, $dadosUserLogin;	$tipoEntrada = $_POST["tipo-entrada"];	if ($tipoEntrada == ""){		$tipoEntrada = "manual";		//if ($modulosGeral['envios']){		//	$tipoEntrada = "cd";		//}		//if ($modulosAtivos['compras']){		//	$tipoEntrada = "compras";		//}	}	else{		$flag = "1";		$codigo = $_POST["localiza-produto-codigo"];		$descricao = $_POST["localiza-descricao-produto"];		$ordemCompra = $_POST["localiza-produto-oc"];		$envioID = $_POST["localiza-produto-envio-id"];		$tipoEnvioID = $_POST["localiza-tipo-envio"];		$numeroSerie = $_POST["localiza-numero-serie"];		$remetenteDestinatario = $_POST["localiza-remetente-destinatario"];		$tipoProdutoID 	= $_POST['localiza-tipo-produto'];	}?>	<div class='movimentacao-container'>		<div class='titulo-container'>			<div class='titulo'>				<p>					Movimenta&ccedil;&atilde;o de Material					<?php if ($flag=="1") echo "<input type='button' value='Executar Movimenta&ccedil;&atilde;o' class='executar-movimentacao esconde' style='float:right;margin-right:0px; width:140px'/>"; ?>				</p>			</div>			<div class='conteudo-interno'>				<div class='titulo-secundario' style='float:left; width:100%; margin-bottom:10px;'>					<p>Realizar Movimenta&ccedil;&atilde;o:</p>					<p><?php				if ($modulosAtivos['compras']){					echo "<input type='radio' id='tipo-entrada-compras' class='tipo-entrada' name='tipo-entrada' value='compras' "; if ($tipoEntrada=='compras') echo 'checked'; echo " ><label for='tipo-entrada-compras'>Compras</label>";				}				if ($modulosGeral['envios']){					echo "<input type='radio' id='tipo-entrada-cd' class='tipo-entrada' name='tipo-entrada' value='cd' "; if ($tipoEntrada=='cd') echo 'checked'; echo " ><label for='tipo-entrada-cd'>Centro de Distribui&ccedil;&atilde;o </label>";				}				//if ($dadosUserLogin['grupoID']=="1"){					echo "<input type='radio' id='tipo-entrada-manual' class='tipo-entrada' name='tipo-entrada' value='manual' "; if ($tipoEntrada=='manual') echo 'checked'; echo " ><label for='tipo-entrada-manual'> Manual </label>";				//}?>					</p>				</div>				<div class='titulo-secundario  div-todos div-compras esconde' style='float:left; width:100%;'>					<div class='titulo-secundario' style='float:left; width:10%'>						<p>Ordem de Compra</p>						<p><input type='text' id='localiza-produto-oc' name='localiza-produto-oc' style='width:95%' value='<?php echo $ordemCompra;?>'></p>					</div>					<div class='titulo-secundario' style='float:left; width:90%'>						<p>Fornecedor</p>						<p><input type='text' id='localiza-fornecedor-oc' name='localiza-fornecedor-oc' style='width:99%' value='<?php echo $fornecedorOC;?>'></p>					</div>				</div>				<div class='titulo-secundario  div-todos div-cd esconde' style='float:left; width:100%;'>					<div class='titulo-secundario' style='float:left; width:10%'>						<p>ID Envio</p>						<p><input type='text' id='localiza-produto-envio-id' name='localiza-produto-envio-id' style='width:95%' value='<?php echo $envioID;?>'></p>					</div>					<div class='titulo-secundario' style='float:left; width:10%;'>						<div class='titulo-secundario' style='float:left; width:98%'>							<p>Tipo</p>							<p><select name="localiza-tipo-envio" id="localiza-tipo-envio"><?php echo optionValueGrupo(59, $tipoEnvioID, "&nbsp;");?><select></p>						</div>					</div>					<div class='titulo-secundario' style='float:left; width:80%'>						<p>Remetente / Destinatário</p>						<p><input type='text' id='localiza-remetente-destinatario' name='localiza-remetente-destinatario' style='width:99%' value='<?php echo $remetenteDestinatario;?>'></p>					</div>				</div>				<div class='titulo-secundario' style='float:left; width:100%;'>					<div class='titulo-secundario' style='float:left; width:10%'>						<p>C&oacute;digo Produto</p>						<p><input type='text' id='localiza-produto-codigo esconde' name='localiza-produto-codigo' value='<?php echo $codigo; ?>' style='width:95%'></p>					</div>					<div class='titulo-secundario' style='float:left; width:50%'>						<p>Descri&ccedil;&atilde;o Produto</p>						<p><input type='text' id='localiza-descricao-produto' name='localiza-descricao-produto' value='<?php echo $descricao; ?>' style='width:98.5%'></p>					</div>					<div class='titulo-secundario' style='float:left; width:20%'>						<p>Tipo</p>						<p><select id='localiza-tipo-produto' name='localiza-tipo-produto'><?php echo optionValueGrupo(13, $tipoProdutoID,"&nbsp;", " and Tipo_ID in (30,175)");?></select></p>					</div>					<div class='titulo-secundario' style='float:left; width:10%'>						<p>Número Série</p>						<p><select id='localiza-numero-serie' name='localiza-numero-serie'><option></option><?php echo optionValueSimNao($numeroSerie);?></select></p>					</div>					<div class='titulo-secundario' style='float:right; width:10%'>						<p><input type='button' value='Pesquisar' class='botao-pesquisar-entrada-material' style='width:99%; margin-top:16px; float:right'></p>					</div>				</div>			</div>		</div>	</div>	<div class='div-retorno'></div>	<input type='hidden' name='produto-id' id='produto-id' value=''/>	<input type='hidden' name='tipo-movimentacao' id='tipo-movimentacao' value='<?php echo $tipoEntrada;?>'/><?php	if ($flag=="1"){		if ($descricao != ""){ $sqlCond .= " and (concat(pd.Nome, ' ', pv.Descricao) like '%$descricao%' or pd.Descricao_Resumida like '%$descricao%')";}		if ($numeroSerie != ""){ $sqlCond .= " and pd.Numero_Serie = '$numeroSerie'";}		if ($tipoProdutoID != ""){ $sqlCond .= " and pd.Tipo_Produto = '$tipoProdutoID'";}		$resultado = mpress_query("SELECT CD_ID, Descricao FROM envios_centros_distribuicao where Situacao_ID = 1");		while($rs = mpress_fetch_array($resultado)){			$arrCD[$rs['CD_ID']]['descricao'] = $rs['Descricao'];			$cdID = $rs['CD_ID'];			$sqlE .= " if (pd.Numero_Serie = 1,							(SELECT SUM(pma.Quantidade) FROM produtos_movimentacoes pma WHERE pma.Produto_Variacao_ID = pv.Produto_Variacao_ID /* AND pma.Situacao_ID = 1 */ AND pma.Numero_Serie != '' AND pma.CD_ID = '$cdID'),							(SELECT SUM(pmb.Quantidade) FROM produtos_movimentacoes pmb WHERE pmb.Produto_Variacao_ID = pv.Produto_Variacao_ID /* AND pmb.Situacao_ID = 1 */ AND pmb.CD_ID = '$cdID'))						AS 'Quantidade_$cdID',";		}		if($tipoEntrada=="manual"){			if ($codigo != ""){ $sqlCond .= " and pv.Codigo = $codigo ";}			$orderBy = " order by pv.Codigo, Nome ";			//$colunas = "5";			/*			$c=1;			$dados[colunas][tamanho][$c++] = "width='70px'";			$dados[colunas][tamanho][$c++] = "";			$dados[colunas][tamanho][$c++] = "width='80px'";			$dados[colunas][tamanho][$c++] = "width='25px'";			$dados[colunas][tamanho][$c++] = "width='090px'";			$dados[colunas][tamanho][$c++] = "width='150px'";			*/			$c=1;			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>C&oacute;digo</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;'>Produto</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Utiliza Número Série</p>";			$dados[colunas][titulo][$c++] 	= "&nbsp;";			//$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Estoque Atual</p>";			foreach($arrCD as $chave => $cd){				$dados[colunas][titulo][$c++] 	= "<center>".$cd[descricao]."</center>";				$dados[colunas][tamanho][$c-1] = "width='090px'";			}			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Executar <br> Entrada / Saída</p>";		}		if($tipoEntrada=="compras"){			if ($ordemCompra != ""){ $sqlCond .= " and cp.Ordem_Compra_ID = $ordemCompra ";}			$sqlJoin = " 	inner join compras_solicitacoes cs on cs.Produto_Variacao_ID = pv.Produto_Variacao_ID						inner join compras_ordens_compras_produtos cp on cp.Compra_Solicitacao_ID = cs.Compra_Solicitacao_ID						inner join compras_ordem_compra_follows cf on cf.Ordem_Compra_ID = cp.Ordem_Compra_ID and cf.Ordem_Compra_Follow_ID = (select max(cfaux.Ordem_Compra_Follow_ID) from compras_ordem_compra_follows cfaux where cfaux.Ordem_Compra_ID = cp.Ordem_Compra_ID) and cf.Situacao_ID = 65						inner join compras_ordem_compras_finalizadas cocf on cocf.Ordem_Compra_ID = cp.Ordem_Compra_ID and cocf.Ordem_Compra_Produto_ID = cp.Ordens_Compras_Produtos_ID and (Quantidade_Aprovada - Quantidade_Entregue) > 0";			$camposConsulta = ", cp.Ordem_Compra_ID as Ordem_Compra_ID, cocf.Quantidade_Aprovada as Quantidade_Aprovada, cocf.Ordem_Compra_Finalizada_ID as Ordem_Compra_Finalizada_ID, cocf.Quantidade_Entregue as Quantidade_Entregue";			$orderBy = " order by cp.Ordem_Compra_ID desc, Nome";			/*			$c=1;			$dados[colunas][tamanho][$c++] = "width='70px'";			$dados[colunas][tamanho][$c++] = "width='70px'";			$dados[colunas][tamanho][$c++] = "";			$dados[colunas][tamanho][$c++] = "width='80px'";			$dados[colunas][tamanho][$c++] = "width='25px'";			$dados[colunas][tamanho][$c++] = "width='090px'";			$dados[colunas][tamanho][$c++] = "width='150px'";			$dados[colunas][tamanho][$c++] = "width='150px'";			$dados[colunas][tamanho][$c++] = "width='150px'";			*/			$c=1;			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;'>Ordem de Compra</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;'>C&oacute;digo</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;'>Produto</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Utiliza Número Série</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>&nbsp;</p>";			//$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Estoque Atual</p>";			foreach($arrCD as $chave => $cd){				$dados[colunas][titulo][$c++] 	= "<center>".$cd[descricao]."</center>";				$dados[colunas][tamanho][$c-1] = "width='090px'";			}			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Quantidade<br>Aprovada</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Quantidade<br>Entregue</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Executar <br> Entrada</p>";		}		if($tipoEntrada=="cd"){			if ($envioID != "") $sqlCond .= " and ew.Workflow_ID = '$envioID' and ewp.Situacao_ID = 1 ";			if ($tipoEnvioID != "") $sqlCond .= " AND ew.Tipo_Envio_ID = '$tipoEnvioID'";			$sqlJoin = "	inner join envios_workflows_produtos ewp on ewp.Produto_Variacao_ID = pv.Produto_Variacao_ID and (ewp.Quantidade - ewp.Quantidade_Entregue) > 0							inner join envios_workflows ew on ew.Workflow_ID = ewp.Workflow_ID							inner join envios_follows ef ON ew.Workflow_ID = ef.Workflow_ID AND ef.Follow_ID = (SELECT MAX(efaux.Follow_ID) FROM envios_follows efaux WHERE ef.Workflow_ID = efaux.Workflow_ID) AND ef.Situacao_ID IN (52,53)							inner join tipo te on te.Tipo_ID = ew.Tipo_Envio_ID ";			$camposConsulta = ", ew.Workflow_ID as Workflow_ID, ewp.Workflow_Produto_ID as Workflow_Produto_ID, ewp.Quantidade as Quantidade_Aprovada, ewp.Quantidade_Entregue as Quantidade_Entregue, te.Descr_Tipo as Tipo_Envio, ew.Tipo_Envio_ID as Tipo_Envio_ID ";			$orderBy = " order by ew.Workflow_ID desc, Nome";			/*			$c=1;			$dados[colunas][tamanho][$c++] = "width='70px'";			$dados[colunas][tamanho][$c++] = "width='70px'";			$dados[colunas][tamanho][$c++] = "";			$dados[colunas][tamanho][$c++] = "width='80px'";			$dados[colunas][tamanho][$c++] = "width='25px'";			$dados[colunas][tamanho][$c++] = "width='090px'";			$dados[colunas][tamanho][$c++] = "width='120px'";			$dados[colunas][tamanho][$c++] = "width='120px'";			$dados[colunas][tamanho][$c++] = "";			$dados[colunas][tamanho][$c++] = "width='150px'";			*/			$c=1;			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Envio ID</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>C&oacute;digo</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;'>Produto</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Utiliza Número Série</p>";			$dados[colunas][titulo][$c++] 	= "&nbsp;";			//$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Estoque Atual</p>";			foreach($arrCD as $chave => $cd){				$dados[colunas][titulo][$c++] 	= "<center>".$cd[descricao]."</center>";				$dados[colunas][tamanho][$c-1] = "width='090px'";			}			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Quantidade para atualização</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Quantidade<br>Entregue / Recebida</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Tipo</p>";			$dados[colunas][titulo][$c++] 	= "<p Style='margin:1px 1px 1px 1px;text-align:center;'>Executar<br>Entrada / Saída</p>";		}		$sql .= "select pd.Produto_ID as Produto_ID, pv.Produto_Variacao_ID as Produto_Variacao_ID, pv.Codigo, concat(coalesce(pd.Nome,''),' ',coalesce(pv.Descricao,'')) as Nome,				Estoque_Minimo, Compra_Minima, Utilizacao_Media, Prazo_Medio_Entrega, Quantidade_Embalagem, pd.Numero_Serie as Numero_Serie,";		$sql .= $sqlE;		$sql .= " mav.Nome_Arquivo as Nome_Arquivo				$camposConsulta				from produtos_dados pd				inner join produtos_variacoes pv on pd.Produto_ID = pv.Produto_ID				$sqlJoin				left join produtos_estoque pe on pe.Produto_Variacao_ID = pv.Produto_Variacao_ID				left join modulos_anexos mav on mav.Anexo_ID = pv.Imagem_ID				where pd.Situacao_ID = 1 and Tipo_Produto in (30,175) and pv.Situacao_ID = 1				$sqlCond				$orderBy";		//echo $sql;		$cont = 0;		$resultado = mpress_query($sql);		while($row = mpress_fetch_array($resultado)){			$i++;			$cont++;			$c=1;			$nomeArquivo = $caminhoSistema."/images/geral/imagem-produto.jpg";			if ($row[Nome_Arquivo]!="")				$nomeArquivo = $caminhoSistema."/uploads/".$row[Nome_Arquivo];			else{				if ($rsAux = mpress_fetch_array(mpress_query("select Nome_Arquivo from modulos_anexos where Chave_Estrangeira = '".$row[Produto_ID]."' and Tabela_Estrangeira = 'produtos' and Situacao_ID = 1 limit 1"))){					$nomeArquivo = $caminhoSistema."/uploads/".$rsAux[Nome_Arquivo];				}			}			$imagemProduto = "<a href='$nomeArquivo' class='fancybox' rel='fancybox'><img style='max-width:25px; max-height:25px' align='center' src='$nomeArquivo'/></a>";			$classeNS = ""; $numeroSerieDesc = "NÃO";			if($row['Numero_Serie']=="1"){ $numeroSerieDesc = "SIM"; $classeNS = "classe-ns";}			$quantidadeBaixa = "0,00";			if($tipoEntrada=="manual"){				$chaveEstrangeiraProduto = $row[Produto_Variacao_ID];			}			if($tipoEntrada=="compras"){				$chaveEstrangeiraProduto = $row['Ordem_Compra_Finalizada_ID'];				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;float:left;'>".$row[Ordem_Compra_ID]."														<input type='hidden' name='ordem-compra-id[]' value='".$row[Ordem_Compra_ID]."'/>														<input type='hidden' name='ordem-compra-finalizada-id[]' value='".$row[Ordem_Compra_Finalizada_ID]."'/>												</p>";				$quantidadeBaixa = ($row["Quantidade_Aprovada"] - $row["Quantidade_Entregue"]);			}			if($tipoEntrada=="cd"){				$chaveEstrangeiraProduto = $row['Workflow_Produto_ID'];				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;float:left;'>".$row['Workflow_ID']."														<input type='hidden' name='envio-id[]' value='".$row['Workflow_ID']."'/>														<input type='hidden' name='envio-produto-id[]' value='".$row['Workflow_Produto_ID']."'/>														</p>";				$quantidadeBaixa = ($row["Quantidade_Aprovada"] - $row["Quantidade_Entregue"]);				if($row['Tipo_Envio_ID']=="130"){					$classeTipo = "entrada";					$quantidadeAprovada = $row[Quantidade_Aprovada];				}				if($row['Tipo_Envio_ID']=="129") {					$quantidadeAprovada = $row[Quantidade_Aprovada]*(-1);					$classeTipo = "saida";					$quantidadeBaixa = $quantidadeBaixa * (-1);				}			}			$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;float:left;'>".$row[Codigo]." </p>";			$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px; float:left;'> $imagemProduto </p> <p Style='margin:1px 1px 1px 1px;'>".$row[Nome]."</p>";			$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'>$numeroSerieDesc<input type='hidden' name='numero-serie[$chaveEstrangeiraProduto]' value='".$row['Numero_Serie']."'></p>";			$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'><div class='btn-retrair btn-expandir-retrair-estoque' produto-variacao-id='".$row[Produto_Variacao_ID]."' pos='$i' style='float:right;' title='Expandir'></div></p>";			//$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'>".number_format($row[Quantidade],2, ',', '.')."</p>";			$totQtdeCD = 0;			foreach($arrCD as $chave => $cd){				$qtdeCD = $row["Quantidade_".$chave];				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 0px 0 0px;text-align:center;'>".number_format($qtdeCD, 2, ',', '.')."</p>";				$totQtdeCD += $qtdeCD;			}			if($tipoEntrada=="cd"){				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'>".number_format($quantidadeAprovada,2, ',', '.')."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'>".number_format($row[Quantidade_Entregue],2, ',', '.')."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;' class='$classeTipo'><b>".$row[Tipo_Envio]."</b></p>";			}			if($tipoEntrada=="compras"){				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'>".number_format($row[Quantidade_Aprovada],2, ',', '.')."</p>";				$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:1px 1px 1px 1px;text-align:center;'>".number_format($row[Quantidade_Entregue],2, ',', '.')."</p>";			}			$dados[colunas][conteudo][$i][$c++] = "	<p Style='margin:1px 1px 1px 1px;text-align:center;'>												<input type='text' style='text-align:center;' name='qtd-movimentacao[]' value='0,00' preencher-com='".number_format($quantidadeBaixa,2, ',', '.')."' class='formata-valor-pos-neg preencher-com $classeNS' pos='$i' chave-estrangeira-produto-id='$chaveEstrangeiraProduto' produto-variacao-id='".$row[Produto_Variacao_ID]."' $readOnly/>												<input type='hidden' name='produto-variacao-id[]' value='".$row[Produto_Variacao_ID]."'/>											</p>";			$i++;			if($i%4==0) $classe = 'tabela-fundo-claro'; else $classe = 'tabela-fundo-escuro';			$dados[colunas][classe][$i-1] = $classe;			$dados[colunas][classe][$i] = $classe." esconde linha-estoque-$i";			$dados[colunas][colspan][$i][1] = $c;			$dados[colunas][conteudo][$i][1] = "<span id='bloco-movimentacao-produto-$i'>&nbsp;</div>";			$colunas = $c - 1;		}		if($i==0){			echo "<p Style='margin:1px 1px 1px 1px;color:red; text-align:center'>Nenhum registro localizado!</p>";		}		else{			$largura = "100%";			echo "	<div class='movimentacao-container'>						<div class='titulo-container'>							<div class='titulo'>								<p>Registros localizados: $cont </p>							</div>							<div class='conteudo-interno'>";			geraTabela($largura,$colunas,$dados, null, 'produtos-movimentacao', 2, 2, 200,"");			echo "			</div>						</div>					</div>";		}		echo "<div class='div-aguarde'></div>";	}?><br><br>