<?phpinclude("functions.php");
if ($_POST){	$laboratorioProdutoID = $_POST['localiza-laboratorio-produto-id'];	$statusID = $_POST['localiza-status-id'];}else{	$statusID = "176";}echo "	<div class='titulo-container'>			<div class='titulo'>				<p>Filtros de Pesquisa</p>			</div>			<div class='conteudo-interno'>				<div class='titulo-secundario' style='float:left; width:10%;'>					<p>ID Laborat&oacute;rio</p>					<p><input type='text' name='localiza-laboratorio-produto-id' id='localiza-laboratorio-produto-id' class='formata-numero' value='".$_POST['localiza-laboratorio-produto-id']."' style='width:93%;'></p>				</div>				<div class='titulo-secundario' style='float:left; width:20%'>					<p>Situa&ccedil;&atilde;o Solicita&ccedil;&atilde;o</p>					<p><select name='localiza-status-id' id='localiza-status-id'>".optionValueGrupo(73, $statusID, "&nbsp;")."<select></p>				</div>				<!--				<div class='titulo-secundario' style='float:left; width:20%'>					<p>Data Solicita&ccedil;&atilde;o</p>					<div style='width:43%;float:left;'>						<p><input type='text' name='data-inicio-abertura' id='data-inicio-abertura' class='formata-data' style='width:95%' maxlength='10' value='".$dataInicio."'>&nbsp;&nbsp;</p>					</div>					<div style='width:10%;text-align:center;float:left;'><p>a</p></div>					<div style='width:43%;float:left;'>						<p><input type='text' name='data-fim-abertura' id='data-fim-abertura' class='formata-data' style='width:95%' maxlength='10' value='".$dataFim."'></p>					</div>				</div>				-->				<div class='titulo-secundario' style='float:left; width:10%; float:right;'>					<p><input type='button' value='Pesquisar' class='botao-pesquisar-laboratorio' style='width:90%; margin-top:15px; margin-bottom:5px; float:right;'/></p>				</div>			</div>		</div>		<input type='hidden' value='' id='lab-prod-id' name='lab-prod-id'>";	if ($laboratorioProdutoID!=''){ $sqlCond .= " and lmp.Laboratorio_Produto_ID = '".$laboratorioProdutoID."'"; }	if ($statusID!=''){ $sqlCond .= " and lmp.Status_ID = '".$statusID."'"; }	if($_POST['ordena-tabela'] != "")		$sqlOrdem = " order by ".$_POST['ordena-tabela']." ".$_POST['ordena-tipo'].", pd.Produto_ID";	else		$sqlOrdem = " order by lp.Laboratorio_Produto_ID desc";	$resultado = mpress_query("SELECT CD_ID, Descricao FROM envios_centros_distribuicao where Situacao_ID = 1 and CD_ID > 0");	while($rs = mpress_fetch_array($resultado)){		$optionValueEstoques .= "<option value='".$rs['CD_ID']."'>".$rs['Descricao']."</option>";		$arrCD[$rs['CD_ID']]['descricao'] = $rs['Descricao'];		$cdID = $rs['CD_ID'];		$sqlE .= " coalesce(if (pda.Numero_Serie = 1,						(SELECT SUM(pma.Quantidade) FROM produtos_movimentacoes pma WHERE pma.Produto_Variacao_ID = pva.Produto_Variacao_ID AND pma.Numero_Serie != '' AND pma.CD_ID = '$cdID'),						(SELECT SUM(pmb.Quantidade) FROM produtos_movimentacoes pmb WHERE pmb.Produto_Variacao_ID = pva.Produto_Variacao_ID AND pmb.CD_ID = '$cdID')),0)					AS 'Quantidade_$cdID',";		//$sqlEstoque = " select "	}	$sql = "select lmp.Laboratorio_Materia_Prima_ID, lmp.Laboratorio_Produto_ID,				trim(concat(coalesce(pdb.Nome,''), ' ', coalesce(pvb.Descricao,''))) as Produto_Laboratorio,				trim(concat(coalesce(pda.Nome,''), ' ', coalesce(pva.Descricao,''))) as Materia_Prima,				lmp.Produto_Variacao_ID, lmp.Quantidade, lmp.Justificativa,				lmp.Responsavel_ID, lmp.Data_Cadastro, r.Nome as Solicitante, lmp.Status_ID, tps.Descr_Tipo as Status_Solicitacao,				".$sqlE."				pm.Produto_Movimentacao_ID				from laboratorio_materia_prima lmp				inner join laboratorio_produtos lp on lp.Laboratorio_Produto_ID = lmp.Laboratorio_Produto_ID				inner join produtos_variacoes pva on pva.Produto_Variacao_ID = lmp.Produto_Variacao_ID				inner join produtos_dados pda on pda.Produto_ID = pva.Produto_ID				inner join produtos_variacoes pvb on pvb.Produto_Variacao_ID = lp.Produto_Variacao_ID				inner join produtos_dados pdb on pdb.Produto_ID = pvb.Produto_ID				inner join tipo tps on tps.Tipo_ID = lmp.Status_ID				left join cadastros_dados as r on r.Cadastro_ID = lmp.Usuario_Cadastro_ID				left join produtos_movimentacoes pm on pm.Chave_Estrangeira = lmp.Laboratorio_Produto_ID																and pm.Chave_Estrangeira_Produto = lmp.Laboratorio_Materia_Prima_ID				where lmp.Situacao_ID = 1				".$sqlCond."				group by lmp.Laboratorio_Materia_Prima_ID				order by lp.Laboratorio_Produto_ID desc, lmp.Data_Cadastro";	//echo $sql;	$resultado = mpress_query($sql);	while($row = mpress_fetch_array($resultado)){		if ($row['Laboratorio_Produto_ID'] != $laboratorioProdutoIDAnt){			$i++;			$dados[colunas][conteudo][$i][1] = "<p Style='margin:2px 5px 0 5px;float:left;' class='link laboratorio-inc-alt' lab-prod-id='".$row['Laboratorio_Produto_ID']."'>".$row['Laboratorio_Produto_ID']."</p>";			$dados[colunas][conteudo][$i][2] = "<p Style='margin:2px 0 0 5px;float:left;'>".$row['Produto_Laboratorio']."</p>";			$dados[colunas][classe][$i] = "tabela-fundo-escuro";		}		$i++;		$dados[colunas][classe][$i] = "tabela-fundo-claro";		$dados[colunas][extras][$i][3] = "valign='top'";		$dados[colunas][extras][$i][4] = "valign='top'";		$dados[colunas][extras][$i][5] = "valign='top'";		$dados[colunas][extras][$i][6] = "valign='top'";		$dados[colunas][conteudo][$i][3] = "<p Style='margin:2px 0 0 5px;float:left;'>".$row['Solicitante']."</p>";		$dados[colunas][conteudo][$i][4] = "<center>".substr(converteData($row[Data_Cadastro],1),0,10)."</center>";		$dados[colunas][conteudo][$i][5] = "<p Style='margin:2px 0 0 5px;float:left; width:100%'>".$row['Materia_Prima']."</p>";		if ($row['Justificativa']!=''){			$dados[colunas][conteudo][$i][5] .= "<p Style='margin:2px 0 0 5px;float:left; width:100%'><b>Justificativa:</b>													<input type='text' name='justificativa-mp[".($linha)."]' value='".$row['Justificativa']."' readonly='readonly' style='width:70%; background: transparent;'/>												 </p>";		}		else{			$dados[colunas][conteudo][$i][5] .= "<input type='hidden' name='justificativa-mp[".($linha)."]' value='".$row['Justificativa']."'/>";					}				$dados[colunas][conteudo][$i][6] = "<p Style='margin:2px 0 0 5px;' align='center'>".number_format($row['Quantidade'],2, ',', '.')."</p>";		$c = 7;		foreach($arrCD as $chave => $cd){			$dados[colunas][extras][$i][$c] = "valign='top'";			$dados[colunas][conteudo][$i][$c++] = "<p Style='margin:2px 0 0 5px;' align='center'>".number_format($row['Quantidade_'.$chave],2, ',', '.')."</p>";		}		if ($row['Status_ID']=='176'){			$dados[colunas][extras][$i][$c] = "valign='top'";				$dados[colunas][conteudo][$i][$c++] = "<center><input type='checkbox' class='produto-aprovar' id='produto-aprovar-$i' value='".$row['Laboratorio_Materia_Prima_ID']."' name='produto-aprovar[$i]' posicao='$i'></center>															<input type='hidden' name='lab-produto-id[$i]' value='".$row['Laboratorio_Produto_ID']."'/>															<input type='hidden' name='lab-mp-id[$i]' value='".$row['Produto_Variacao_ID']."'/>															<input type='hidden' name='lab-quant[$i]' value='".$row['Quantidade']."'/>";			$dados[colunas][extras][$i][$c] = "valign='top'";				$dados[colunas][conteudo][$i][$c++] = "<center><input type='checkbox' class='produto-cancelar' id='produto-cancelar-$i' value='".$row['Laboratorio_Materia_Prima_ID']."' name='produto-cancelar[$i]' posicao='$i'></center>";					}		else{			$dados[colunas][colspan][$i][$c] = "2";			$dados[colunas][conteudo][$i][$c] = "<center><b>".$row['Status_Solicitacao']."</b></center>";		}		$linha = $i;			$i++;		$dados[colunas][classe][$i] = "tabela-fundo-claro esconde retira-estoque-mp-".($linha);		$dados[colunas][colspan][$i][5] = 4 + count($arrCD);		if ($row['Quantidade']>0){			$sDescricao = "Entrada no estoque:";		}					else{			$sDescricao = "Retirada do estoque:";		}		$dados[colunas][conteudo][$i][5] = "<p Style='margin:2px 0 0 5px;float:left; width:100%;'>												<b>$sDescricao</b>												<select name='retira-estoque-mp[".($linha)."]' id='retira-estoque-mp-".($linha)."'>".$optionValueEstoques."</select>											</p>";		$laboratorioProdutoIDAnt = $row['Laboratorio_Produto_ID'];	}	$largura = "100.2%";	$colunas = "8";	$dados[colunas][titulo][1] 	= "ID Lab.";	$dados[colunas][tamanho][1] = "width='50px'";	$dados[colunas][titulo][2] 	= "Material em Análise";	$dados[colunas][titulo][3] 	= "Solicitante";	$dados[colunas][titulo][4] 	= "<center>Data Solicitação</center>";	$dados[colunas][titulo][5] 	= "Material Solicitado";	$dados[colunas][titulo][6] 	= "<center>Quantiedade</center>";	$c = 7;	foreach($arrCD as $chave => $cd){		$dados[colunas][titulo][$c++] = "<center>Estoque Atual <br>".$cd[descricao]."</center>";	}	$dados[colunas][tamanho][$c] = "width='42px'";	$dados[colunas][titulo][$c++] = "<center><img src='../images/geral/disponivel.png' class='seleciona-todas-aprovar' style='cursor:pointer' title='Aceitar Todas'></center>";	$dados[colunas][tamanho][$c] = "width='42px'";	$dados[colunas][titulo][$c++] = "<center><img src='../images/geral/indisponivel.png' class='seleciona-todas-cancelar' style='cursor:pointer' title='Negar Todas'></center>";	echo "	<div class='titulo-container'>				<div class='titulo'>					<p>						Solicita&ccedil;&otilde;es de Mat&eacute;ria Prima						<input type='button' class='executar-movimentacao esconde' value='Executar'/>					</p>				</div>				<div class='conteudo-interno'>";	geraTabela($largura, $c-1, $dados, '', 'laboratorio-solicitacoes-mp', 2, 2, 100,1);	echo "		</div>			</div>";	if($i==0){		echo "<p Style='margin:2px 5px 0 5px;color:red; text-align:center'>Nenhum registro localizado</p>";	}?>